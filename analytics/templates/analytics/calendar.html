{% extends "base.html" %}

{% block content %}

<!-- âœ… èƒŒæ™¯UIï¼ˆãƒ›ãƒ¼ãƒ é¢¨ï¼šå˜è‰²ï¼‹ç·šï¼‹è¼ªã£ã‹ï¼ã‚°ãƒ©ãƒ‡ç„¡ã—ï¼‰ -->
<div aria-hidden="true" class="fixed inset-0 -z-10 overflow-hidden pointer-events-none"
     style="background:#c8d8d6;">
  <!-- å·¦ä¸Šã®è¼ªã£ã‹ -->
  <svg class="absolute -top-24 -left-24 w-[360px] h-[360px] opacity-35" viewBox="0 0 360 360" fill="none">
    <circle cx="110" cy="110" r="95" stroke="white" stroke-width="2"/>
    <circle cx="170" cy="140" r="140" stroke="white" stroke-width="1.6" opacity="0.65"/>
  </svg>

  <!-- ã†ã£ã™ã‚‰æ³¢ç·šï¼ˆå·¦ä¸Šï¼‰ -->
  <svg class="absolute top-10 left-10 w-[260px] h-[120px] opacity-30" viewBox="0 0 260 120" fill="none">
    <path d="M5 70 C60 30, 120 110, 255 55" stroke="white" stroke-width="2" opacity="0.55"/>
    <path d="M10 90 C70 40, 130 115, 250 70" stroke="white" stroke-width="1.6" opacity="0.35"/>
  </svg>

  <!-- ä¸­å¤®ä¸‹ã®æŠ˜ã‚Œç·šã£ã½ã„ç·šï¼ˆã‚¹ã‚¯ã‚·ãƒ§ã®é›°å›²æ°—ï¼‰ -->
  <svg class="absolute bottom-20 left-1/2 -translate-x-1/2 w-[520px] h-[180px] opacity-35" viewBox="0 0 520 180" fill="none">
    <path d="M40 150 L270 80 L480 140" stroke="white" stroke-width="3" opacity="0.55"/>
    <path d="M40 150 L270 80 L480 140" stroke="#0f172a" stroke-width="6" opacity="0.10"/>
    <circle cx="270" cy="80" r="7" fill="#0f172a" opacity="0.35"/>
  </svg>

  <!-- ã»ã‚“ã®å°‘ã—ã ã‘ãƒã‚¤ã‚ºã£ã½ã„ç‚¹ï¼ˆä»»æ„ï¼šã„ã‚‰ãªã‘ã‚Œã°æ¶ˆã—ã¦OKï¼‰ -->
  <div class="absolute inset-0 opacity-[0.08]"
       style="background-image:radial-gradient(circle at 1px 1px, rgba(255,255,255,.8) 1px, transparent 1px);
              background-size:22px 22px;"></div>
</div>



<!-- âœ… ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯èƒŒæ™¯ã‚ˆã‚Šä¸Šã« -->
<div class="relative z-10 max-w-4xl mx-auto px-4 sm:px-6 pt-6 pb-28">

  <!-- âœ… å¤–æ ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆè£…é£¾ï¼‰â€»ã“ã“ã§é–‰ã˜ãªã„ï¼å…¨ä½“ã‚’åŒ…ã‚€ -->
  <div class="rounded-3xl border border-gray-200 shadow-sm
              bg-gradient-to-b from-teal-50/70 via-white to-white
              p-4 sm:p-6">

    <!-- ===== Header / Controls Card ===== -->
    <div class="rounded-2xl bg-white border border-gray-200 shadow-sm p-5 sm:p-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-sm text-gray-500">åˆ†æ</p>
          <h1 class="mt-1 text-2xl sm:text-3xl font-extrabold tracking-tight text-gray-900">åˆ†æãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
          <p class="mt-1 text-sm text-gray-500">æ—¥ã”ã¨ã®å£²ä¸Šã¨ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
        </div>

        <!-- ã‚°ãƒ©ãƒ•ã¸ï¼ˆâ€»æ—¥å ±ç™»éŒ²ãƒœã‚¿ãƒ³é¢¨ï¼‰ -->
        <a href="{% url 'analytics:dashboard' %}"
          class="shrink-0 inline-flex items-center gap-2 rounded-xl bg-teal-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-teal-700 transition">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <rect x="3" y="10" width="4" height="10" rx="1"/>
            <rect x="10" y="6" width="4" height="14" rx="1"/>
            <rect x="17" y="3" width="4" height="17" rx="1"/>
          </svg>
          ã‚°ãƒ©ãƒ•ã¸
        </a>
      </div>

      <!-- ===== æœˆç§»å‹• ===== -->
      <div class="mt-5 flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-2">
          <a href="?year={{ prev.year }}&month={{ prev.month }}"
            class="h-10 px-3 inline-flex items-center justify-center rounded-xl border border-gray-200 bg-white
                    text-gray-700 hover:bg-gray-50 transition">
            <span class="text-lg leading-none mr-1">&lsaquo;</span> å‰ã¸
          </a>

          <div class="px-4 py-2 rounded-xl bg-gray-50 border border-gray-200 text-sm font-semibold text-gray-900">
            {{ year }}å¹´ {{ month_name }}
          </div>

          <a href="?year={{ next.year }}&month={{ next.month }}"
            class="h-10 px-3 inline-flex items-center justify-center rounded-xl border border-gray-200 bg-white
                    text-gray-700 hover:bg-gray-50 transition">
            æ¬¡ã¸ <span class="text-lg leading-none ml-1">&rsaquo;</span>
          </a>
        </div>

        <!-- å‡¡ä¾‹ï¼ˆä¸Šã ã‘ã«ã™ã‚‹ï¼šé‡è¤‡é˜²æ­¢ï¼‰ -->
        <div class="flex flex-wrap items-center gap-3 text-xs text-gray-600">
          <div class="inline-flex items-center gap-2"><span class="inline-flex w-3 h-3 rounded-full bg-red-500"></span>ã‚¯ãƒ¬ãƒ¼ãƒ </div>
          <div class="inline-flex items-center gap-2"><span class="inline-flex w-3 h-3 rounded-full bg-amber-400"></span>æ•…éšœ</div>
          <div class="inline-flex items-center gap-2"><span class="inline-flex w-3 h-3 rounded-full bg-emerald-500"></span>è³è³›</div>
          <div class="inline-flex items-center gap-2"><span class="inline-flex w-3 h-3 rounded-full bg-sky-500"></span>å ±å‘Š</div>
          <div class="inline-flex items-center gap-2"><span class="inline-flex w-3 h-3 rounded-full bg-violet-500"></span>ãã®ä»–</div>
        </div>
      </div>
    </div>

    <!-- ===== Calendar Card ===== -->
    <div class="mt-6 bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full table-fixed border-collapse">
          <thead>
            <tr class="bg-gray-50">
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">æ—¥</th>
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">æœˆ</th>
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">ç«</th>
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">æ°´</th>
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">æœ¨</th>
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">é‡‘</th>
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">åœŸ</th>
            </tr>
          </thead>

          <tbody>
            {% for week in calendar_grid %}
              <tr>
                {% for cell in week %}
                  <td class="relative align-top h-[120px] sm:h-[132px] border-t border-gray-200 border-r border-gray-200 last:border-r-0
                             {% if not cell.in_month %} bg-gray-50 text-gray-400 {% else %} bg-white {% endif %}">
                    <!-- ã‚»ãƒ«å…¨é¢ã‚¯ãƒªãƒƒã‚¯ï¼ˆå½“æœˆã ã‘åå¿œï¼‰ -->
                    <button type="button"
                            class="absolute inset-0 {% if cell.in_month %}hover:bg-gray-50{% endif %} transition"
                            data-ymd="{{ cell.date|date:'Y-m-d' }}"
                            data-inmonth="{% if cell.in_month %}1{% else %}0{% endif %}"
                            aria-label="Open day detail"></button>

                    <div class="pointer-events-none p-3">
                      <div class="flex items-start justify-between">
                        <div class="text-xs font-extrabold {% if cell.in_month %}text-gray-900{% else %}text-gray-400{% endif %}">
                          {{ cell.date|date:"j" }}
                        </div>
                      </div>

                      <div class="mt-3 text-center">
                        {% if cell.sales_yen %}
                          <div class="text-base sm:text-lg font-extrabold text-gray-900">Â¥{{ cell.sales_yen_str }}</div>
                        {% else %}
                          <div class="text-base sm:text-lg font-extrabold text-gray-300">&nbsp;</div>
                        {% endif %}
                      </div>

                      <div class="mt-3 flex flex-wrap justify-center gap-x-3 gap-y-2 text-sm">
                        {% if cell.claim %}
                          <span class="inline-flex items-center gap-1 font-bold text-gray-700">
                            <span class="inline-flex w-5 h-5 rounded-full bg-red-500 text-white items-center justify-center text-xs">!</span>
                            {{ cell.claim }}
                          </span>
                        {% endif %}
                        {% if cell.trouble %}
                          <span class="inline-flex items-center gap-1 font-bold text-gray-700">
                            <span class="inline-flex w-5 h-5 rounded-full bg-amber-400 text-gray-900 items-center justify-center text-xs">!</span>
                            {{ cell.trouble }}
                          </span>
                        {% endif %}
                        {% if cell.praise %}
                          <span class="inline-flex items-center gap-1 font-bold text-gray-700">
                            <span class="inline-flex w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs">!</span>
                            {{ cell.praise }}
                          </span>
                        {% endif %}
                        {% if cell.report %}
                          <span class="inline-flex items-center gap-1 font-bold text-gray-700">
                            <span class="inline-flex w-5 h-5 rounded-full bg-sky-500 text-white items-center justify-center text-xs">ğŸ’¬</span>
                            {{ cell.report }}
                          </span>
                        {% endif %}
                        {% if cell.other %}
                          <span class="inline-flex items-center gap-1 font-bold text-gray-700">
                            <span class="inline-flex w-5 h-5 rounded-full bg-violet-500 text-white items-center justify-center text-xs">â€¦</span>
                            {{ cell.other }}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div><!-- âœ… å¤–æ ãƒ•ãƒ¬ãƒ¼ãƒ ã“ã“ã§é–‰ã˜ã‚‹ -->
</div><!-- âœ… relative z-10 wrapper end -->


<!-- =========================
     Bottom Sheetï¼ˆè©³ç´°ï¼‰
     ========================= -->
<div id="daySheetOverlay" class="fixed inset-0 bg-black/30 hidden z-40"></div>

<div id="daySheet" class="fixed inset-x-0 bottom-0 z-50 translate-y-full transition-transform duration-200">
  <div class="bg-white rounded-t-2xl shadow-2xl h-[88vh] flex flex-col">
    <div class="pt-3 pb-1 flex justify-center">
      <div class="h-1 w-24 bg-gray-200 rounded-full"></div>
    </div>

    <div class="px-4 pb-3 border-b border-gray-200 flex items-start justify-between">
      <div>
        <div id="daySheetDate" class="text-lg font-extrabold text-gray-900">----</div>
        <div id="daySheetSales" class="text-sm text-gray-500 mt-1"></div>
      </div>
      <button type="button" id="daySheetClose"
              class="h-10 w-10 grid place-items-center rounded-xl hover:bg-gray-100 text-gray-600 transition"
              aria-label="Close">
        <span class="text-2xl leading-none">Ã—</span>
      </button>
    </div>

    <div id="daySheetBody" class="flex-1 overflow-auto p-4">
      <div class="text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>
  </div>
</div>

<script>
(() => {
  const sheet = document.getElementById("daySheet");
  const overlay = document.getElementById("daySheetOverlay");
  const closeBtn = document.getElementById("daySheetClose");
  const dateEl = document.getElementById("daySheetDate");
  const salesEl = document.getElementById("daySheetSales");
  const bodyEl = document.getElementById("daySheetBody");

  const dayApiTemplate = "{% url 'analytics:calendar_day_api' ymd='__YMD__' %}";
  let opened = false;

  function openSheet() {
    if (opened) return;
    opened = true;
    overlay.classList.remove("hidden");
    sheet.classList.remove("translate-y-full");
    document.documentElement.classList.add("overflow-hidden");
  }

  function closeSheet() {
    if (!opened) return;
    opened = false;
    sheet.classList.add("translate-y-full");
    setTimeout(() => { if (!opened) overlay.classList.add("hidden"); }, 200);
    document.documentElement.classList.remove("overflow-hidden");
  }

  closeBtn.addEventListener("click", closeSheet);
  overlay.addEventListener("click", closeSheet);
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeSheet(); });

  const genreToLabel = (k) => ({
    claim:"ã‚¯ãƒ¬ãƒ¼ãƒ ", trouble:"æ•…éšœ", praise:"è³è³›", report:"å ±å‘Š", other:"ãã®ä»–"
  }[k] || "ãã®ä»–");

  const genreToColor = (k) => ({
    claim:"#ef4444",
    trouble:"#fbbf24",
    praise:"#10b981",
    report:"#0ea5e9",
    other:"#8b5cf6"
  }[k] || "#8b5cf6");

  async function loadDay(ymd){
    openSheet();
    bodyEl.innerHTML = '<div class="text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
    salesEl.textContent = "";

    try{
      const url = dayApiTemplate.replace("__YMD__", ymd);
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" }});
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || "failed");

      dateEl.textContent = data.date_label || ymd;

      if (data.sales_yen !== null && data.sales_yen !== undefined){
        salesEl.textContent = `å£²ä¸Šï¼šÂ¥${data.sales_yen}`;
      } else {
        salesEl.textContent = "";
      }

      if(!data.items || data.items.length === 0){
        bodyEl.innerHTML = '<div class="text-sm text-gray-500">ã“ã®æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      bodyEl.innerHTML = data.items.map(item => {
        const bar = genreToColor(item.genre_key);
        const meta = `${genreToLabel(item.genre_key)}${item.place ? "ï½œ" + item.place : ""}ï½œ${item.time || ""}`;
        const title = (item.title || "ï¼ˆã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®šï¼‰");

        return `
          <a class="block rounded-xl border border-gray-200 hover:bg-gray-50 transition p-3 mb-3"
             href="${item.detail_url}">
            <div class="flex gap-3">
              <div class="w-1 rounded-full" style="background:${bar}"></div>
              <div class="flex-1">
                <div class="text-xs text-gray-500">${meta}</div>
                <div class="text-sm font-extrabold text-gray-900 mt-1">${title}</div>
              </div>
              <div class="text-gray-300 text-lg">â€º</div>
            </div>
          </a>
        `;
      }).join("");

    }catch(e){
      console.error(e);
      bodyEl.innerHTML = `<div class="text-sm text-gray-500">å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
    }
  }

  document.querySelectorAll("td button[data-ymd]").forEach(btn => {
    btn.addEventListener("click", () => {
      if (btn.dataset.inmonth === "0") return;
      const ymd = btn.dataset.ymd;
      if (ymd) loadDay(ymd);
    });
  });
})();
</script>

{% endblock %}
