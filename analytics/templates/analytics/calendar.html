{% extends "base.html" %}

{% block content %}

<div aria-hidden="true" class="fixed inset-0 -z-10 overflow-hidden pointer-events-none"
     style="background:#c8d8d6;">
</div>

<div class="relative z-10 max-w-4xl mx-auto px-4 sm:px-6 pt-6 pb-28">

  <div class="rounded-3xl border border-gray-200 shadow-sm
              bg-gradient-to-b from-teal-50/70 via-white to-white
              p-4 sm:p-6">

    <div class="rounded-2xl bg-white border border-gray-200 shadow-sm p-5 sm:p-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-sm text-gray-500">åˆ†æ</p>
          <h1 class="mt-1 text-2xl sm:text-3xl font-extrabold tracking-tight text-gray-900">åˆ†æãƒ»ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
          <p class="mt-1 text-sm text-gray-500">æ—¥ã”ã¨ã®å£²ä¸Šã¨ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
        </div>

        <a href="{% url 'analytics:dashboard' %}"
          class="shrink-0 inline-flex items-center gap-2 rounded-xl bg-teal-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-teal-700 transition">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <rect x="3" y="10" width="4" height="10" rx="1"/>
            <rect x="10" y="6" width="4" height="14" rx="1"/>
            <rect x="17" y="3" width="4" height="17" rx="1"/>
          </svg>
          ã‚°ãƒ©ãƒ•ã¸
        </a>
      </div>

      <div class="mt-5 flex flex-col lg:flex-row items-center justify-between gap-5">
        <div class="flex items-center justify-center w-full lg:w-auto gap-1.5 sm:gap-2">
          <a href="?year={{ prev.year }}&month={{ prev.month }}"
            class="h-9 px-3 inline-flex items-center justify-center rounded-xl border border-gray-200 bg-white
                    text-gray-700 text-xs sm:text-sm font-bold hover:bg-gray-50 transition shrink-0 shadow-sm">
            <span class="text-lg leading-none mr-1">&lsaquo;</span> å‰ã¸
          </a>

          <div class="px-4 py-2 rounded-xl bg-gray-50 border border-gray-200 text-xs sm:text-sm font-bold text-gray-900 whitespace-nowrap shadow-inner">
            {{ year }}å¹´ {{ month_name }}
          </div>

          <a href="?year={{ next.year }}&month={{ next.month }}"
            class="h-9 px-3 inline-flex items-center justify-center rounded-xl border border-gray-200 bg-white
                    text-gray-700 text-xs sm:text-sm font-bold hover:bg-gray-50 transition shrink-0 shadow-sm">
            æ¬¡ã¸ <span class="text-lg leading-none ml-1">&rsaquo;</span>
          </a>
        </div>

        <div class="flex flex-wrap justify-center items-center gap-3 text-[10px] sm:text-xs text-gray-600">
          <div class="inline-flex items-center gap-1.5"><span class="inline-flex w-2.5 h-2.5 rounded-full bg-red-500"></span>ã‚¯ãƒ¬ãƒ¼ãƒ </div>
          <div class="inline-flex items-center gap-1.5"><span class="inline-flex w-2.5 h-2.5 rounded-full bg-amber-400"></span>äº‹æ•…</div>
          <div class="inline-flex items-center gap-1.5"><span class="inline-flex w-2.5 h-2.5 rounded-full bg-emerald-500"></span>è³è³›</div>
          <div class="inline-flex items-center gap-1.5"><span class="inline-flex w-2.5 h-2.5 rounded-full bg-sky-500"></span>å ±å‘Š</div>
          <div class="inline-flex items-center gap-1.5"><span class="inline-flex w-2.5 h-2.5 rounded-full bg-violet-500"></span>ãã®ä»–</div>
        </div>
      </div>
    </div>

    <div class="mt-6 bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full table-fixed border-collapse">
          <thead>
            <tr class="bg-gray-50">
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">æ—¥</th>
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">æœˆ</th>
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">ç«</th>
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">æ°´</th>
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">æœ¨</th>
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">é‡‘</th>
              <th class="p-3 text-xs font-bold text-gray-600 border-b border-gray-200">åœŸ</th>
            </tr>
          </thead>

          <tbody>
            {% for week in calendar_grid %}
              <tr>
                {% for cell in week %}
                  <td class="relative align-top h-[110px] border-t border-gray-200 border-r border-gray-200 last:border-r-0
                             {% if not cell.in_month %} bg-gray-50 text-gray-400 {% else %} bg-white {% endif %}">
                    
                    <button type="button"
                            class="absolute inset-0 {% if cell.in_month %}hover:bg-gray-50{% endif %} transition"
                            data-ymd="{{ cell.date|date:'Y-m-d' }}"
                            data-inmonth="{% if cell.in_month %}1{% else %}0{% endif %}"
                            aria-label="Open day detail"></button>

                    <div class="pointer-events-none p-3">
                      <div class="flex items-start justify-between">
                        <div class="text-xs font-extrabold {% if cell.in_month %}text-gray-900{% else %}text-gray-400{% endif %}">
                          {{ cell.date|date:"j" }}
                        </div>
                      </div>

                      <div class="mt-4"></div>

                      <div class="mt-3 flex flex-wrap justify-center gap-x-3 gap-y-2 text-sm">
                        {% if cell.claim %}
                          <span class="inline-flex items-center gap-1 font-bold text-gray-700">
                            <span class="inline-flex w-5 h-5 rounded-full bg-red-500 text-white items-center justify-center text-xs">!</span>
                            {{ cell.claim }}
                          </span>
                        {% endif %}
                        {% if cell.trouble %}
                          <span class="inline-flex items-center gap-1 font-bold text-gray-700">
                            <span class="inline-flex w-5 h-5 rounded-full bg-amber-400 text-gray-900 items-center justify-center text-xs">!</span>
                            {{ cell.trouble }}
                          </span>
                        {% endif %}
                        {% if cell.praise %}
                          <span class="inline-flex items-center gap-1 font-bold text-gray-700">
                            <span class="inline-flex w-5 h-5 rounded-full bg-emerald-500 text-white items-center justify-center text-xs">!</span>
                            {{ cell.praise }}
                          </span>
                        {% endif %}
                        {% if cell.report %}
                          <span class="inline-flex items-center gap-1 font-bold text-gray-700">
                            <span class="inline-flex w-5 h-5 rounded-full bg-sky-500 text-white items-center justify-center text-xs">ğŸ’¬</span>
                            {{ cell.report }}
                          </span>
                        {% endif %}
                        {% if cell.other %}
                          <span class="inline-flex items-center gap-1 font-bold text-gray-700">
                            <span class="inline-flex w-5 h-5 rounded-full bg-violet-500 text-white items-center justify-center text-xs">â€¦</span>
                            {{ cell.other }}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>


<div id="daySheetOverlay" class="fixed inset-0 bg-black/30 hidden z-40"></div>

<div id="daySheet" class="fixed inset-x-0 bottom-0 z-50 translate-y-full transition-transform duration-200">
  <div class="bg-white rounded-t-2xl shadow-2xl h-[88vh] flex flex-col">
    <div class="pt-3 pb-1 flex justify-center">
      <div class="h-1 w-24 bg-gray-200 rounded-full"></div>
    </div>

    <div class="px-4 pb-3 border-b border-gray-200 flex items-start justify-between">
      <div>
        <div id="daySheetDate" class="text-lg font-extrabold text-gray-900">----</div>
        <div id="daySheetSales" class="text-sm text-gray-700 mt-1 font-bold"></div>
      </div>
      <button type="button" id="daySheetClose"
              class="h-10 w-10 grid place-items-center rounded-xl hover:bg-gray-100 text-gray-600 transition"
              aria-label="Close">
        <span class="text-2xl leading-none">Ã—</span>
      </button>
    </div>

    <div id="daySheetBody" class="flex-1 overflow-auto p-4">
      <div class="text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>
  </div>
</div>

<script>
(() => {
  const sheet = document.getElementById("daySheet");
  const overlay = document.getElementById("daySheetOverlay");
  const closeBtn = document.getElementById("daySheetClose");
  const dateEl = document.getElementById("daySheetDate");
  const salesEl = document.getElementById("daySheetSales");
  const bodyEl = document.getElementById("daySheetBody");

  const dayApiTemplate = "{% url 'analytics:calendar_day_api' ymd='__YMD__' %}";
  let opened = false;

  function openSheet() {
    if (opened) return;
    opened = true;
    overlay.classList.remove("hidden");
    sheet.classList.remove("translate-y-full");
    document.documentElement.classList.add("overflow-hidden");
  }

  function closeSheet() {
    if (!opened) return;
    opened = false;
    sheet.classList.add("translate-y-full");
    setTimeout(() => { if (!opened) overlay.classList.add("hidden"); }, 200);
    document.documentElement.classList.remove("overflow-hidden");
  }

  closeBtn.addEventListener("click", closeSheet);
  overlay.addEventListener("click", closeSheet);

  // âœ… JSå†…ã®ãƒ©ãƒ™ãƒ«ä¿®æ­£: trouble â†’ äº‹æ•…
  const genreToLabel = (k) => ({
    claim:"ã‚¯ãƒ¬ãƒ¼ãƒ ", trouble:"äº‹æ•…", praise:"è³è³›", report:"å ±å‘Š", other:"ãã®ä»–"
  }[k] || "ãã®ä»–");

  const genreToColor = (k) => ({
    claim:"#ef4444", trouble:"#fbbf24", praise:"#10b981", report:"#0ea5e9", other:"#8b5cf6"
  }[k] || "#8b5cf6");

  async function loadDay(ymd){
    openSheet();
    bodyEl.innerHTML = '<div class="text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
    salesEl.textContent = "";

    try{
      const url = dayApiTemplate.replace("__YMD__", ymd);
      const res = await fetch(url);
      const data = await res.json();
      if(!data.ok) throw new Error("failed");

      dateEl.textContent = data.date_label || ymd;

      if (data.sales_yen !== null && data.sales_yen !== undefined){
        salesEl.textContent = `å£²ä¸Šï¼šÂ¥${Number(data.sales_yen).toLocaleString()}`;
      }

      if(!data.items || data.items.length === 0){
        bodyEl.innerHTML = '<div class="text-sm text-gray-500">ã“ã®æ—¥ã®è¨˜éŒ²ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      bodyEl.innerHTML = data.items.map(item => {
        const title = (item.title || "ï¼ˆã‚¿ã‚¤ãƒˆãƒ«æœªè¨­å®šï¼‰");
        return `
          <a class="block rounded-xl border border-gray-200 hover:bg-gray-50 transition p-3 mb-3" href="${item.detail_url}">
            <div class="flex gap-3">
              <div class="w-1 rounded-full" style="background:${genreToColor(item.genre_key)}"></div>
              <div class="flex-1">
                <div class="text-xs text-gray-500">${genreToLabel(item.genre_key)}ï½œ${item.time || ""}</div>
                <div class="text-sm font-extrabold text-gray-900 mt-1">${title}</div>
              </div>
              <div class="text-gray-300">â€º</div>
            </div>
          </a>
        `;
      }).join("");

    }catch(e){
      bodyEl.innerHTML = `<div class="text-sm text-gray-500">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>`;
    }
  }

  document.querySelectorAll("td button[data-ymd]").forEach(btn => {
    btn.addEventListener("click", () => {
      if (btn.dataset.inmonth === "0") return;
      loadDay(btn.dataset.ymd);
    });
  });
})();
</script>

{% endblock %}