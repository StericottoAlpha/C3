{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 sm:p-6">
  <h1 class="text-2xl font-bold mb-6 text-gray-900">分析・グラフ</h1>

  <div id="error-message" class="bg-red-100 text-red-800 p-3 rounded-lg mb-5 hidden"></div>

  <!-- グラフコントロール -->
  <div class="flex flex-wrap gap-3 mb-5">
    <!-- グラフ種類選択 -->
    <select id="graph-type" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      <option value="sales">売上</option>
      <option value="customer_count">客数</option>
      <option value="incident_by_location">場所別インシデント</option>
      <option value="monthly_goal">月次目標</option>
    </select>

    <select id="genre-filter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent hidden">
      <option value="">全ジャンル</option>
      <option value="claim">クレーム</option>
      <option value="praise">賞賛</option>
      <option value="accident">事故</option>
      <option value="report">報告</option>
      <option value="other">その他</option>
    </select>

    <!-- スコープ切替（自店舗 / 全店舗） -->
    <div id="scope-selector" class="flex items-center gap-3">
      <label class="inline-flex items-center">
        <input type="radio" name="scope" value="own" id="scope-own" class="mr-2" />
        <span>自店舗</span>
      </label>
      <label class="inline-flex items-center">
        <input type="radio" name="scope" value="all" id="scope-all" class="mr-2" />
        <span>全店舗</span>
      </label>
    </div>

    <!-- 期間切り替え（週/月/プレビュー） -->
    <div class="flex gap-2">
      <button id="btn-week" class="px-4 py-2 border border-gray-300 rounded-lg text-sm cursor-pointer transition-colors hover:bg-gray-50 bg-blue-500 text-white border-blue-500" onclick="changePeriod('week')">週</button>
      <button id="btn-month" class="px-4 py-2 border border-gray-300 bg-white rounded-lg text-sm cursor-pointer transition-colors hover:bg-gray-50" onclick="changePeriod('month')">月</button>
      <button id="btn-preview" class="px-4 py-2 border border-gray-300 bg-white rounded-lg text-sm cursor-pointer transition-colors hover:bg-gray-50" onclick="changePeriod('preview')">プレビュー</button>
    </div>
  </div>

  <!-- 期間移動ナビゲーション -->
  <div class="flex items-center gap-3 mb-6">
    <button onclick="movePeriod(-1)" class="px-4 py-2 border border-gray-300 bg-white rounded-lg text-sm cursor-pointer transition-colors hover:bg-gray-50">&lt;</button>
    <div id="period-label" class="font-semibold min-w-[200px] text-center text-gray-900">読込中...</div>
    <button onclick="movePeriod(1)" class="px-4 py-2 border border-gray-300 bg-white rounded-lg text-sm cursor-pointer transition-colors hover:bg-gray-50">&gt;</button>
  </div>

  <!-- グラフ表示エリア -->
  <div class="bg-white p-5 rounded-lg shadow-sm">
    <div id="loading" class="text-center py-10 text-gray-500">データを読み込み中...</div>
    <canvas id="analytics-chart" class="hidden"></canvas>

    <!-- 月次目標表示エリア -->
    <div id="monthly-goal-container" class="hidden">
      <h2 class="text-lg font-bold mb-4 text-gray-900">今月の目標</h2>
      <div id="goal-content">
        <div class="mb-4">
          <h3 class="text-sm font-semibold text-gray-600 mb-2">目標内容</h3>
          <div id="goal-text" class="whitespace-pre-wrap text-gray-900"></div>
        </div>
        <div class="mb-4">
          <h3 class="text-sm font-semibold text-gray-600 mb-2">達成率</h3>
          <div class="flex items-center gap-3">
            <div class="flex-1 bg-gray-200 rounded-full h-6">
              <div id="achievement-bar" class="bg-blue-500 h-6 rounded-full transition-all duration-300 flex items-center justify-center text-white text-sm font-semibold" style="width: 0%">
                <span id="achievement-rate">0%</span>
              </div>
            </div>
          </div>
        </div>
        <div>
          <h3 class="text-sm font-semibold text-gray-600 mb-2">達成状況</h3>
          <div id="achievement-text" class="text-gray-900"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 場所別インシデント推移グラフ（場所別インシデント選択時のみ表示） -->
  <div id="location-trend-section" class="mt-6 hidden">
    <div class="bg-white p-5 rounded-lg shadow-sm">
      <div class="mb-4">
        <label for="location-select" class="block text-sm font-semibold text-gray-700 mb-2">場所を選択</label>
        <select id="location-select" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          <option value="all">全て</option>
          <option value="kitchen">キッチン</option>
          <option value="hall">ホール</option>
          <option value="cashier">レジ</option>
          <option value="toilet">トイレ</option>
          <option value="other">その他</option>
        </select>
      </div>
      <div id="location-trend-loading" class="text-center py-10 text-gray-500 hidden">データを読み込み中...</div>
      <canvas id="location-trend-chart" class="hidden"></canvas>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  let currentChart = null;
  let locationTrendChart = null;
  let currentOffset = 0;
  let currentPeriod = localStorage.getItem('analytics_period') || 'week';
  let currentGraphType = localStorage.getItem('analytics_graph_type') || 'sales';
  let currentGenre = localStorage.getItem('analytics_genre') || '';
  let currentScope = localStorage.getItem('analytics_scope') || '{{ default_scope|default:"own" }}';
  let currentGoalYear = null;
  let currentGoalMonth = null;
  let currentLocation = 'all';

  // スコープ切替（自店舗 / 全店舗）
  document.querySelectorAll('input[name="scope"]').forEach(function(radio) {
    radio.addEventListener('change', function(e) {
      currentScope = e.target.value;
      localStorage.setItem('analytics_scope', currentScope);


      // 月次目標は店舗単位のみ対応しているため、全店舗選択時は月次目標をロードしない
      if (currentGraphType === 'monthly_goal' && currentScope === 'all') {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('analytics-chart').classList.add('hidden');
        document.getElementById('monthly-goal-container').classList.add('hidden');
        document.getElementById('error-message').textContent = '全店舗の月次目標は表示できません';
        document.getElementById('error-message').classList.remove('hidden');
      } else {
        if (currentGraphType === 'monthly_goal') {
          loadMonthlyGoal();
        } else {
          loadGraph();
        }
      }
    });
  });

  // グラフ種類変更
  document.getElementById('graph-type').addEventListener('change', function(e) {
    currentGraphType = e.target.value;
    localStorage.setItem('analytics_graph_type', currentGraphType);

    // 場所別インシデントの場合、ジャンルフィルタと場所別推移セクションを表示
    const genreFilter = document.getElementById('genre-filter');
    const locationTrendSection = document.getElementById('location-trend-section');
    if (currentGraphType === 'incident_by_location') {
      genreFilter.classList.remove('hidden');
      locationTrendSection.classList.remove('hidden');
    } else {
      genreFilter.classList.add('hidden');
      locationTrendSection.classList.add('hidden');
    }

    // 週/月/プレビュー切り替えボタンと全店舗ラジオボタンの表示/非表示
    const weekBtn = document.getElementById('btn-week');
    const monthBtn = document.getElementById('btn-month');
    const previewBtn = document.getElementById('btn-preview');
    const scopeSelector = document.getElementById('scope-selector');

    if (currentGraphType === 'monthly_goal') {
      // 月次目標の場合は週/月/プレビューボタンと全店舗ラジオボタンを非表示
      weekBtn.classList.add('hidden');
      monthBtn.classList.add('hidden');
      previewBtn.classList.add('hidden');
      if (scopeSelector) {
        scopeSelector.classList.add('hidden');
      }
      loadMonthlyGoal();
    } else {
      // その他の場合は週/月/プレビューボタンと全店舗ラジオボタンを表示
      weekBtn.classList.remove('hidden');
      monthBtn.classList.remove('hidden');
      previewBtn.classList.remove('hidden');
      if (scopeSelector) {
        scopeSelector.classList.remove('hidden');
      }
      loadGraph();
    }
  });

  // ジャンルフィルタ変更
  document.getElementById('genre-filter').addEventListener('change', function(e) {
    currentGenre = e.target.value;
    localStorage.setItem('analytics_genre', currentGenre);
    loadGraph();
    // 場所選択済みの場合は場所別推移グラフも更新
    if (currentLocation) {
      loadLocationTrendGraph();
    }
  });

  // 場所選択
  document.getElementById('location-select').addEventListener('change', function(e) {
    currentLocation = e.target.value;
    loadLocationTrendGraph();
  });

  // 期間切り替え（週/月/プレビュー）
  function changePeriod(period) {
    currentPeriod = period;
    localStorage.setItem('analytics_period', period);
    currentOffset = 0;  // 期間切り替え時は現在に戻す

    // ボタンのアクティブ状態を切り替え
    const weekBtn = document.getElementById('btn-week');
    const monthBtn = document.getElementById('btn-month');
    const previewBtn = document.getElementById('btn-preview');

    // すべてのボタンを非アクティブに
    [weekBtn, monthBtn, previewBtn].forEach(btn => {
      btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
      btn.classList.add('bg-white');
    });

    // 選択されたボタンをアクティブに
    let activeBtn;
    if (period === 'week') {
      activeBtn = weekBtn;
    } else if (period === 'month') {
      activeBtn = monthBtn;
    } else if (period === 'preview') {
      activeBtn = previewBtn;
    }

    if (activeBtn) {
      activeBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
      activeBtn.classList.remove('bg-white');
    }

    // プレビューモードの場合は上部のグラフを非表示
    const mainGraphContainer = document.querySelector('.bg-white.p-5.rounded-lg.shadow-sm');
    if (period === 'preview' && currentGraphType === 'incident_by_location') {
      if (mainGraphContainer) {
        mainGraphContainer.style.display = 'none';
      }
      // 場所別推移グラフのみ更新
      if (currentLocation) {
        loadLocationTrendGraph();
      }
    } else {
      // 週・月モードの場合は上部のグラフを表示
      if (mainGraphContainer) {
        mainGraphContainer.style.display = 'block';
      }

      // 月次目標の場合は目標を再読み込み
      if (currentGraphType === 'monthly_goal') {
        loadMonthlyGoal();
      } else {
        loadGraph();
        // 場所選択済みの場合は場所別推移グラフも更新
        if (currentGraphType === 'incident_by_location' && currentLocation) {
          loadLocationTrendGraph();
        }
      }
    }
  }

  // 期間移動（前/次）
  function movePeriod(direction) {
    // 月次目標の場合は月を移動
    if (currentGraphType === 'monthly_goal') {
      const date = new Date(currentGoalYear, currentGoalMonth - 1);
      date.setMonth(date.getMonth() + direction);
      currentGoalYear = date.getFullYear();
      currentGoalMonth = date.getMonth() + 1;
      loadMonthlyGoal();
    } else {
      currentOffset += direction;
      loadGraph();
      // 場所選択済みの場合は場所別推移グラフも更新
      if (currentGraphType === 'incident_by_location' && currentLocation) {
        loadLocationTrendGraph();
      }
    }
  }

  // グラフデータを読み込み
  function loadGraph() {
    // ローディング表示
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('analytics-chart').classList.add('hidden');
    document.getElementById('monthly-goal-container').classList.add('hidden');
    document.getElementById('error-message').classList.add('hidden');

    // APIからデータ取得
    let url = `/analysis/api/graph-data/?graph_type=${currentGraphType}&period=${currentPeriod}&offset=${currentOffset}&scope=${currentScope}`;

    // ジャンルフィルタがある場合は追加
    if (currentGraphType === 'incident_by_location' && currentGenre) {
      url += `&genre=${currentGenre}`;
    }

    // 全店舗かつ場所別インシデントの場合は常に比較（compare=1）を付与
    if (currentGraphType === 'incident_by_location' && currentScope === 'all') {
      url += '&compare=1';
    }

    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('データの取得に失敗しました');
        }
        return response.json();
      })
      .then(data => {
        // 期間ラベル更新
        document.getElementById('period-label').textContent = data.period_label;

        // グラフ描画
        drawChart(data);

        // ローディング非表示
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('analytics-chart').classList.remove('hidden');
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error-message').textContent = 'データの読み込みに失敗しました: ' + error.message;
        document.getElementById('error-message').classList.remove('hidden');
      });
  }

  // グラフ描画
  function drawChart(data) {
    const ctx = document.getElementById('analytics-chart').getContext('2d');

    // 既存のグラフを破棄
    if (currentChart) {
      currentChart.destroy();
    }

    // データの型判定
    const hasDatasets = data.datasets !== undefined;
    const chartKind = data.chart_kind || (hasDatasets ? 'bar' : 'line');
    const chartType = chartKind;
    // 比較モード（自店舗 vs 他店平均）が有効かどうかを判定
    let compareMode = false;
    if (chartKind === 'bar' && hasDatasets) {
      compareMode = data.datasets.some(ds => ds.label && ds.label.indexOf('（自店舗）') !== -1);
    }
    const isStackedChart = (chartType === 'bar' && hasDatasets && !compareMode);

    // データセットの準備
    let datasets;
    if (chartKind === 'bar' && hasDatasets) {
      // 比較モード（自店舗 vs 他店平均）の場合はグループ化して横並びの棒にする
      if (compareMode) {
        // 比較モードでは「自店舗」と「他店平均」いずれも自店舗と同じ外観に揃える
        datasets = data.datasets.map((dataset, index) => {
          const baseColor = dataset.backgroundColor;

          // 可能ならグラデーションを生成（非比較の積み上げ棒と同じ処理）
          const gradient = ctx.createLinearGradient(0, 0, 0, 400);
          let gradientApplied = false;

          if (typeof baseColor === 'string') {
            const rgbaMatch = baseColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
            if (rgbaMatch) {
              const r = rgbaMatch[1], g = rgbaMatch[2], b = rgbaMatch[3];
              gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.9)`);
              gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0.6)`);
              gradientApplied = true;
            }
          }

          return {
            ...dataset,
            backgroundColor: gradientApplied ? gradient : baseColor,
            borderWidth: 0,
            // borderRadius を削除し、代わりに以下を追加
            borderRadius: 6,      // 全体に適用
            borderSkipped: 'bottom', // 下側の角を丸くしない設定
            barPercentage: 0.8,
            categoryPercentage: 0.9
          };
        });
      } else {
        // 通常の積み上げ棒グラフ用（場所別インシデントなど）
        datasets = data.datasets.map((dataset, index) => {
          const gradient = ctx.createLinearGradient(0, 0, 0, 400);
          const baseColor = dataset.backgroundColor;
          let gradientApplied = false;

          if (typeof baseColor === 'string') {
            const rgbaMatch = baseColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
            if (rgbaMatch) {
              const r = rgbaMatch[1], g = rgbaMatch[2], b = rgbaMatch[3];
              gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.9)`);
              gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0.6)`);
              gradientApplied = true;
            }
          }

          return {
            ...dataset,
            backgroundColor: gradientApplied ? gradient : baseColor,
            borderWidth: 0,
            borderRadius: {
              topLeft: 8,
              topRight: 8,
              bottomLeft: 8,
              bottomRight: 8
            },
            borderSkipped: false,
            // 棒幅を広くして見やすくする
            barPercentage: 0.9,
            categoryPercentage: 1.0,
            // 固定幅を設定
            barThickness: 36,
            // 最大幅を制限
            maxBarThickness: 80
          };
        });
      }
    } else if (chartKind === 'line' && hasDatasets) {
      // 複数ライン（全店舗表示）
      datasets = data.datasets.map((dataset, index) => {
        const border = dataset.borderColor || 'rgb(59, 130, 246)';
        let bg = dataset.backgroundColor || border;
        if (typeof bg === 'string' && bg.startsWith('rgb(')) {
          bg = bg.replace('rgb', 'rgba').replace(')', ', 0.08)');
        }
        return {
          ...dataset,
          borderColor: border,
          backgroundColor: bg,
          fill: false,
          tension: dataset.tension !== undefined ? dataset.tension : 0.3,
          pointRadius: dataset.pointRadius !== undefined ? dataset.pointRadius : 3,
        };
      });
    } else {
      // 単一の折れ線グラフ
      datasets = [{
        label: data.title,
        data: data.data,
        borderColor: 'rgb(59, 130, 246)',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        tension: 0.3,
        fill: true,
        borderWidth: 2,
        pointRadius: 4,
        pointBackgroundColor: 'rgb(59, 130, 246)',
      }];
    }

    // y軸の目盛りステップを決定（比較モードでは小数表示を許容）
    let yStepSize = currentGraphType === 'sales' ? 100000 : (currentGraphType === 'customer_count' ? 100 : 1);
    if (compareMode && chartType === 'bar' && currentGraphType !== 'sales' && currentGraphType !== 'customer_count') {
      yStepSize = 0.5;
    }

    // 新しいグラフを作成
    currentChart = new Chart(ctx, {
      type: chartType,
      data: {
        labels: data.labels,
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            // grouped-stacked 比較表示のときは凡例を「場所ごと」にまとめて表示し、クリックでその場所の自/他両方をトグル
            labels: {
              usePointStyle: true,
              pointStyle: 'circle',
              padding: 15,
              font: {
                size: 12,
                weight: '500'
              },
              generateLabels: function(chart) {
                // compareMode のときのみユニークな場所ラベルを生成
                if (!compareMode) {
                  return Chart.overrides && Chart.overrides.plugins && Chart.overrides.plugins.legend && Chart.overrides.plugins.legend.labels && Chart.overrides.plugins.legend.labels.generateLabels ? Chart.overrides.plugins.legend.labels.generateLabels(chart) : Chart.defaults.plugins.legend.labels.generateLabels(chart);
                }
                const datasets = chart.data.datasets || [];
                const unique = {};
                datasets.forEach((d, i) => {
                  const loc = d.location_label || ('' + d.label).replace(/（.*）$/, '');
                  if (!unique[loc]) {
                    unique[loc] = { text: loc, fillStyle: d.backgroundColor, hidden: false, datasetIndex: i };
                  }
                });
                return Object.keys(unique).map(k => ({ text: unique[k].text, fillStyle: unique[k].fillStyle, hidden: unique[k].hidden, datasetIndex: unique[k].datasetIndex }));
              }
            },
            onClick: function(e, legendItem) {
              // compareMode のときは、クリックされた場所に対応するすべてのデータセット（自/他）をトグル
              if (!compareMode) {
                Chart.defaults.plugins.legend.onClick.call(this, e, legendItem);
                return;
              }
              const chart = this.chart;
              const label = legendItem.text;
              chart.data.datasets.forEach(ds => {
                const loc = ds.location_label || ('' + ds.label).replace(/（.*）$/, '');
                if (loc === label) {
                  ds.hidden = !ds.hidden;
                }
              });
              chart.update();
            }
          },
          title: {
            display: true,
            text: data.title,
            font: {
              size: 18,
              weight: 'bold'
            },
            padding: {
              top: 10,
              bottom: 20
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            cornerRadius: 8,
            titleFont: {
              size: 14,
              weight: 'bold'
            },
            bodyFont: {
              size: 13
            },
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += context.parsed.y;
                }
                return label;
              }
            }
          }
        },
        scales: {
          x: {
            stacked: isStackedChart || compareMode, 
            grid: {
              display: false
            },
            ticks: {
              font: {
                size: 11
              }
            }
          },
          y: {
            stacked: isStackedChart || compareMode,
            beginAtZero: true,
            min: 0,
            grid: {
              color: 'rgba(0, 0, 0, 0.06)',
              drawBorder: false
            },
            ticks: {
              stepSize: yStepSize,
              font: {
                size: 11
              },
              callback: function(value) {
                if (currentGraphType === 'sales') {
                  return '¥' + value.toLocaleString();
                }
                // 小数値を 0.5 刻みで見やすく表示（必要なら小数点を表示）
                if (yStepSize < 1) {
                  return value.toString();
                }
                return value;
              }
            }
          }
        }
      }
    });
  }

  // 場所別インシデント推移グラフを読み込み
  function loadLocationTrendGraph() {
    // ローディング表示
    document.getElementById('location-trend-loading').classList.remove('hidden');
    document.getElementById('location-trend-chart').classList.add('hidden');

    // APIからデータ取得
    let url = `/analysis/api/graph-data/?graph_type=incident_trend_by_location&period=${currentPeriod}&offset=${currentOffset}&location=${currentLocation}`;

    // ジャンルフィルタがある場合は追加
    if (currentGenre) {
      url += `&genre=${currentGenre}`;
    }

    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error('データの取得に失敗しました');
        }
        return response.json();
      })
      .then(data => {
        // 折れ線グラフ描画
        drawLocationTrendChart(data);

        // ローディング非表示
        document.getElementById('location-trend-loading').classList.add('hidden');
        document.getElementById('location-trend-chart').classList.remove('hidden');
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('location-trend-loading').classList.add('hidden');
      });
  }

  // 場所別インシデント推移グラフを描画
  function drawLocationTrendChart(data) {
    const ctx = document.getElementById('location-trend-chart').getContext('2d');

    // 既存のグラフを破棄
    if (locationTrendChart) {
      locationTrendChart.destroy();
    }

    // 折れ線グラフを作成
    locationTrendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [{
          label: data.title,
          data: data.data,
          borderColor: 'rgb(59, 130, 246)',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderWidth: 2,
          tension: 0.1,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: true,
            position: 'top'
          },
          title: {
            display: true,
            text: data.title
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 1
            }
          }
        }
      }
    });
  }

  // 月次目標を読み込み
  function loadMonthlyGoal() {
    // 既存のグラフを破棄
    if (currentChart) {
      currentChart.destroy();
      currentChart = null;
    }

    // ローディング表示
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('analytics-chart').classList.add('hidden');
    document.getElementById('monthly-goal-container').classList.add('hidden');
    document.getElementById('error-message').classList.add('hidden');

    // 年月を取得（初回は今月、2回目以降は保存された値）
    const today = new Date();
    if (currentGoalYear === null || currentGoalMonth === null) {
      currentGoalYear = today.getFullYear();
      currentGoalMonth = today.getMonth() + 1;
    }

    const year = currentGoalYear;
    const month = currentGoalMonth;

    // 期間ラベル更新
    document.getElementById('period-label').textContent = `${year}年${month}月`;

    // APIからデータ取得
    fetch(`/analysis/api/monthly-goal/?year=${year}&month=${month}`)
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => {
            throw new Error(`目標データの取得に失敗しました (${response.status}): ${text}`);
          });
        }
        return response.json();
      })
      .then(data => {
        // 目標内容を表示
        document.getElementById('goal-text').textContent = data.goal_text;

        // 目標が設定されていない場合
        if (data.goal_text === '目標が設定されていません') {
          // 達成率とコメントを非表示
          document.getElementById('achievement-rate').textContent = '-';
          document.getElementById('achievement-bar').style.width = '0%';
          document.getElementById('achievement-text').textContent = '管理者に目標の設定を依頼してください';
        } else {
          // 達成率を表示
          const rate = data.achievement_rate;
          document.getElementById('achievement-rate').textContent = rate + '%';
          document.getElementById('achievement-bar').style.width = rate + '%';

          // 達成率に応じて色を変更
          const bar = document.getElementById('achievement-bar');
          if (rate >= 80) {
            bar.classList.remove('bg-blue-500', 'bg-yellow-500');
            bar.classList.add('bg-green-500');
          } else if (rate >= 50) {
            bar.classList.remove('bg-blue-500', 'bg-green-500');
            bar.classList.add('bg-yellow-500');
          } else {
            bar.classList.remove('bg-green-500', 'bg-yellow-500');
            bar.classList.add('bg-blue-500');
          }

          // 達成状況を表示
          document.getElementById('achievement-text').textContent = data.achievement_text;
        }

        // ローディング非表示、月次目標を表示
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('monthly-goal-container').classList.remove('hidden');
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error-message').textContent = '目標データの読み込みに失敗しました: ' + error.message;
        document.getElementById('error-message').classList.remove('hidden');
      });
  }

  // 初期ロード
  document.addEventListener('DOMContentLoaded', function() {
    // localStorageから保存された値をUIに反映
    const graphTypeSelect = document.getElementById('graph-type');
    graphTypeSelect.value = currentGraphType;

    const genreFilter = document.getElementById('genre-filter');
    genreFilter.value = currentGenre;

    // 場所別インシデントの場合、ジャンルフィルタと場所別推移セクションを表示
    if (currentGraphType === 'incident_by_location') {
      genreFilter.classList.remove('hidden');
      document.getElementById('location-trend-section').classList.remove('hidden');
    }

    // 週/月/プレビューボタンの状態を復元
    const weekBtn = document.getElementById('btn-week');
    const monthBtn = document.getElementById('btn-month');
    const previewBtn = document.getElementById('btn-preview');

    // すべてのボタンを非アクティブに
    [weekBtn, monthBtn, previewBtn].forEach(btn => {
      btn.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
      btn.classList.add('bg-white');
    });

    // 選択されたボタンをアクティブに
    let activeBtn;
    if (currentPeriod === 'week') {
      activeBtn = weekBtn;
    } else if (currentPeriod === 'month') {
      activeBtn = monthBtn;
    } else if (currentPeriod === 'preview') {
      activeBtn = previewBtn;
    }

    if (activeBtn) {
      activeBtn.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
      activeBtn.classList.remove('bg-white');
    }

    // スコープラジオの初期値をセット
    const scopeOwn = document.getElementById('scope-own');
    const scopeAll = document.getElementById('scope-all');
    if (currentScope === 'all') {
      scopeAll.checked = true;
    } else {
      scopeOwn.checked = true;
    }



    // 月次目標の場合は週/月/プレビューボタンと全店舗ラジオボタンを非表示
    const scopeSelector = document.getElementById('scope-selector');
    if (currentGraphType === 'monthly_goal') {
      weekBtn.classList.add('hidden');
      monthBtn.classList.add('hidden');
      previewBtn.classList.add('hidden');
      if (scopeSelector) {
        scopeSelector.classList.add('hidden');
      }
      loadMonthlyGoal();
    } else {
      // プレビューモードかつ場所別インシデントの場合
      if (currentPeriod === 'preview' && currentGraphType === 'incident_by_location') {
        // 上部のグラフを非表示
        const mainGraphContainer = document.querySelector('.bg-white.p-5.rounded-lg.shadow-sm');
        if (mainGraphContainer) {
          mainGraphContainer.style.display = 'none';
        }
        // 場所別推移グラフのみ表示
        loadLocationTrendGraph();
      } else {
        loadGraph();
        // 場所別インシデントの場合、場所別推移グラフも表示
        if (currentGraphType === 'incident_by_location') {
          loadLocationTrendGraph();
        }
      }
    }
  });
</script>
{% endblock %}
