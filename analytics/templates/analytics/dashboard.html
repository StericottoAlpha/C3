{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 sm:p-6">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-bold text-gray-900">分析・グラフ</h1>
    <a href="/analysis/calendar/"
       class="shrink-0 inline-flex items-center gap-2 rounded-xl bg-teal-600 px-3 py-2 text-sm font-semibold text-white shadow hover:bg-teal-700 transition">
      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a3 3 0 0 1 3 3v12a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h1V3a1 1 0 0 1 1-1zm0 7a1 1 0 0 0 0 2h10a1 1 0 1 0 0-2H7z"/>
      </svg>
      カレンダーへ
    </a>
  </div>
  <p class="mt-1 text-sm text-white">期間や表示内容を切り替えて確認できます。</p>

  <div id="error-message" class="bg-red-100 text-red-800 p-3 rounded-lg mb-5 hidden"></div>

<!-- ✅ 背景UI（ホーム風：単色＋線＋輪っか／グラデ無し） -->
<div aria-hidden="true"
     class="fixed inset-0 -z-10 overflow-hidden pointer-events-none"
     style="background:#c8d8d6;">
  <!-- 左上の輪っか -->
  <svg class="absolute -top-24 -left-24 w-[360px] h-[360px] opacity-35" viewBox="0 0 360 360" fill="none">
    <circle cx="110" cy="110" r="95" stroke="white" stroke-width="2"/>
    <circle cx="170" cy="140" r="140" stroke="white" stroke-width="1.6" opacity="0.65"/>
  </svg>

  <!-- うっすら波線（左上） -->
  <svg class="absolute top-10 left-10 w-[260px] h-[120px] opacity-30" viewBox="0 0 260 120" fill="none">
    <path d="M5 70 C60 30, 120 110, 255 55" stroke="white" stroke-width="2" opacity="0.55"/>
    <path d="M10 90 C70 40, 130 115, 250 70" stroke="white" stroke-width="1.6" opacity="0.35"/>
  </svg>

  <!-- 中央下の折れ線っぽい線 -->
  <svg class="absolute bottom-20 left-1/2 -translate-x-1/2 w-[520px] h-[180px] opacity-35" viewBox="0 0 520 180" fill="none">
    <path d="M40 150 L270 80 L480 140" stroke="white" stroke-width="3" opacity="0.55"/>
    <path d="M40 150 L270 80 L480 140" stroke="#0f172a" stroke-width="6" opacity="0.10"/>
    <circle cx="270" cy="80" r="7" fill="#0f172a" opacity="0.35"/>
  </svg>

  <!-- ノイズ（不要ならこのdivを消してOK） -->
  <div class="absolute inset-0 opacity-[0.08]"
       style="background-image:radial-gradient(circle at 1px 1px, rgba(255,255,255,.8) 1px, transparent 1px);
              background-size:22px 22px;"></div>
</div>

<div class="max-w-4xl mx-auto px-2 sm:px-4 pt-6 pb-28">
  <div class="p-0 sm:p-0">

  <!-- ===== Header / Controls Card ===== -->
  <div class="rounded-2xl bg-white border border-gray-200 shadow-sm p-5 sm:p-6">
    <!-- エラー表示 -->
    <div id="error-message"
         class="mb-4 hidden rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"></div>

    <!-- ===== Controls ===== -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">

      <!-- グラフ種類 -->
      <div class="lg:col-span-3">
        <label class="block text-xs font-semibold text-gray-600 mb-1">表示内容</label>
        <select id="graph-type"
                class="w-full px-3 py-2.5 border border-gray-300 rounded-xl text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-teal-300 focus:border-transparent">
          <option value="sales">売上</option>
          <option value="customer_count">客数</option>
          <option value="incident_by_location">場所別の出来事データ</option>
          <option value="monthly_goal">月次目標</option>
        </select>
      </div>

      <!-- ✅ ジャンル（ラベル含めて丸ごと出し分け） -->
      <div id="genre-filter-wrap" class="lg:col-span-3 hidden">
        <label class="block text-xs font-semibold text-gray-600 mb-1">ジャンル</label>
        <select id="genre-filter"
                class="w-full px-3 py-2.5 border border-gray-300 rounded-xl text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-teal-300 focus:border-transparent">
          <!-- <option value="">全ジャンル(賞賛を除く)</option> -->
          <option value="">ネガティブジャンル(クレーム・事故)</option>
          <option value="claim">クレーム</option>
          <option value="praise">賞賛</option>
          <option value="accident">事故</option>
          <option value="report">報告</option>
          <option value="other">その他</option>
        </select>
      </div>

      <!-- スコープ -->
      <div id="scope-selector" class="lg:col-span-5">
        <label class="block text-xs font-semibold text-gray-600 mb-1">範囲</label>
        <div class="w-full flex items-center justify-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2.5">
          <label class="inline-flex items-center gap-2 text-sm text-gray-700">
            <input type="radio" name="scope" value="own" id="scope-own" class="h-4 w-4 accent-teal-600" />
            自店舗
          </label>
          <div class="h-4 w-px bg-gray-200 mx-1"></div>
          <label class="inline-flex items-center gap-2 text-sm text-gray-700">
            <input type="radio" name="scope" value="all" id="scope-all" class="h-4 w-4 accent-teal-600" />
            他店舗比較
          </label>
        </div>
      </div>

      <!-- 期間切替 + 期間移動 -->
      <div class="lg:col-span-12">
        <div class="flex flex-wrap items-center justify-center gap-3">

          <div id="period-selector" class="w-full flex items-center justify-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2.5">
            <label class="inline-flex items-center gap-2 text-sm text-gray-700">
              <input type="radio" name="period" value="week" id="period-week" class="h-4 w-4 accent-teal-600" />
              週
            </label>
            <div class="h-4 w-px bg-gray-200 mx-1"></div>
            <label class="inline-flex items-center gap-2 text-sm text-gray-700">
              <input type="radio" name="period" value="month" id="period-month" class="h-4 w-4 accent-teal-600" />
              月
            </label>
            <div class="h-4 w-px bg-gray-200 mx-1"></div>
            <label class="inline-flex items-center gap-2 text-sm text-gray-700">
              <input type="radio" name="period" value="preview" id="period-preview" class="h-4 w-4 accent-teal-600" />
              月間プレビュー
            </label>
          </div>

          <div class="flex items-center gap-2">
            <button onclick="movePeriod(-1)"
                    class="h-10 w-10 grid place-items-center rounded-xl border border-gray-200 bg-white
                           text-gray-700 hover:bg-gray-50 transition"
                    aria-label="前へ">
              <span class="text-lg leading-none">&lsaquo;</span>
            </button>

            <div id="period-label"
                 class="whitespace-nowrap text-center text-sm font-semibold text-gray-900 px-3 py-2 rounded-xl bg-gray-50 border border-gray-200">
              読込中...
            </div>

            <button onclick="movePeriod(1)"
                    class="h-10 w-10 grid place-items-center rounded-xl border border-gray-200 bg-white
                           text-gray-700 hover:bg-gray-50 transition"
                    aria-label="次へ">
              <span class="text-lg leading-none">&rsaquo;</span>
            </button>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- ===== Main Graph Card ===== -->
  <div id="mainGraphCard" data-main-graph="1"
       class="mt-6 bg-white border border-gray-200 rounded-2xl shadow-sm p-5 sm:p-6">
    <div id="loading" class="text-center py-10 text-gray-500">データを読み込み中...</div>
    <div id="chart-container" class="relative" style="min-height: 250px;">
      <canvas id="analytics-chart" class="hidden"></canvas>
    </div>

    <!-- 月次目標 -->
    <div id="monthly-goal-container" class="hidden">
      <h2 class="text-lg font-extrabold mb-4 text-gray-900">今月の目標</h2>

      <div id="goal-content" class="space-y-5">
        <div>
          <h3 class="text-xs font-bold text-gray-600 mb-2">目標内容</h3>
          <div id="goal-text" class="whitespace-pre-wrap text-gray-900 text-sm leading-relaxed"></div>
        </div>

        <div>
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-xs font-bold text-gray-600">達成率</h3>
            <span id="achievement-rate" class="text-sm font-extrabold text-gray-900">0%</span>
          </div>

          <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
            <div id="achievement-bar"
                 class="bg-teal-600 h-6 rounded-full transition-all duration-300 flex items-center justify-center
                        text-white text-xs font-bold"
                 style="width: 0%">
              <span class="sr-only">達成率</span>
            </div>
          </div>
        </div>

        <div>
          <h3 class="text-xs font-bold text-gray-600 mb-2">達成状況</h3>
          <div id="achievement-text" class="text-sm text-gray-900"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Location Trend ===== -->
  <div id="location-trend-section" class="mt-6 hidden">
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-5 sm:p-6">
      <div class="flex flex-wrap items-end justify-between gap-3 mb-4">
        <div>
          <p class="text-sm font-extrabold text-gray-900">場所別できごと数の推移</p>
          <p class="text-xs text-gray-500 mt-1">場所を選択して推移を確認できます。</p>
        </div>

        <div class="min-w-[200px]">
          <label for="location-select" class="block text-xs font-semibold text-gray-600 mb-1">場所</label>
          <select id="location-select"
                  class="w-full px-3 py-2.5 border border-gray-300 rounded-xl text-sm bg-white
                         focus:outline-none focus:ring-2 focus:ring-teal-300 focus:border-transparent">
            <option value="all">全て</option>
            <option value="kitchen">キッチン</option>
            <option value="hall">ホール</option>
            <option value="cashier">レジ</option>
            <option value="toilet">トイレ</option>
            <option value="other">その他</option>
          </select>
        </div>
      </div>

      <div id="location-trend-loading" class="text-center py-10 text-gray-500 hidden">データを読み込み中...</div>
      <div id="location-trend-chart-container" class="hidden">
        <canvas id="location-trend-chart"></canvas>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  let currentChart = null;
  let locationTrendChart = null;
  let currentOffset = 0;
  let currentPeriod = localStorage.getItem('analytics_period') || 'week';
  let currentGraphType = localStorage.getItem('analytics_graph_type') || 'sales';
  let currentGenre = localStorage.getItem('analytics_genre') || '';
  let currentScope = localStorage.getItem('analytics_scope') || '{{ default_scope|default:"own" }}';
  let currentGoalYear = null;
  let currentGoalMonth = null;
  let currentLocation = 'all';

  // スコープ切替（自店舗 / 他店舗比較）
  document.querySelectorAll('input[name="scope"]').forEach(function(radio) {
    radio.addEventListener('change', function(e) {
      currentScope = e.target.value;
      localStorage.setItem('analytics_scope', currentScope);

      if (currentGraphType === 'monthly_goal' && currentScope === 'all') {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('analytics-chart').classList.add('hidden');
        document.getElementById('monthly-goal-container').classList.add('hidden');
        document.getElementById('error-message').textContent = '全店舗の月次目標は表示できません';
        document.getElementById('error-message').classList.remove('hidden');
      } else {
        if (currentGraphType === 'monthly_goal') {
          loadMonthlyGoal();
        } else {
          loadGraph();
          // 場所別できごとの場合は推移グラフも再読み込み
          if (currentGraphType === 'incident_by_location') {
            loadLocationTrendGraph();
          }
        }
      }
    });
  });

  // グラフ種類変更
  document.getElementById('graph-type').addEventListener('change', function(e) {
    currentGraphType = e.target.value;
    localStorage.setItem('analytics_graph_type', currentGraphType);

    const genreFilterWrap = document.getElementById('genre-filter-wrap');
    const locationTrendSection = document.getElementById('location-trend-section');

    if (currentGraphType === 'incident_by_location') {
      genreFilterWrap.classList.remove('hidden');
      locationTrendSection.classList.remove('hidden');
    } else {
      genreFilterWrap.classList.add('hidden');
      locationTrendSection.classList.add('hidden');
    }

    // 週/月/プレビュー切り替えと全店舗ラジオボタンの表示/非表示
    const periodSelector = document.getElementById('period-selector');
    const scopeSelector = document.getElementById('scope-selector');

    if (currentGraphType === 'monthly_goal') {
      // 月次目標の場合は週/月/プレビューと全店舗ラジオボタンを非表示
      if (periodSelector) periodSelector.classList.add('hidden');
      if (scopeSelector) scopeSelector.classList.add('hidden');
      loadMonthlyGoal();
    } else {
      // その他の場合は週/月/プレビューと全店舗ラジオボタンを表示
      if (periodSelector) periodSelector.classList.remove('hidden');
      if (scopeSelector) scopeSelector.classList.remove('hidden');
      loadGraph();
    }
  });

  // ジャンルフィルタ変更
  document.getElementById('genre-filter').addEventListener('change', function(e) {
    currentGenre = e.target.value;
    localStorage.setItem('analytics_genre', currentGenre);
    loadGraph();
    if (currentLocation) loadLocationTrendGraph();
  });

  // 場所選択
  document.getElementById('location-select').addEventListener('change', function(e) {
    currentLocation = e.target.value;
    loadLocationTrendGraph();
  });

  // 期間ラジオボタン変更
  document.querySelectorAll('input[name="period"]').forEach(function(radio) {
    radio.addEventListener('change', function(e) {
      changePeriod(e.target.value);
    });
  });

  // 期間切り替え（週/月/プレビュー）
  function changePeriod(period) {
    currentPeriod = period;
    localStorage.setItem('analytics_period', period);
    currentOffset = 0;

    const mainGraphContainer = document.getElementById('mainGraphCard');

    if (period === 'preview' && currentGraphType === 'incident_by_location') {
      if (mainGraphContainer) mainGraphContainer.style.display = 'none';
      if (currentLocation) loadLocationTrendGraph();
    } else {
      if (mainGraphContainer) mainGraphContainer.style.display = 'block';

      if (currentGraphType === 'monthly_goal') {
        loadMonthlyGoal();
      } else {
        loadGraph();
        if (currentGraphType === 'incident_by_location' && currentLocation) {
          loadLocationTrendGraph();
        }
      }
    }
  }

  // 期間移動（前/次）
  function movePeriod(direction) {
    if (currentGraphType === 'monthly_goal') {
      const date = new Date(currentGoalYear, currentGoalMonth - 1);
      date.setMonth(date.getMonth() + direction);
      currentGoalYear = date.getFullYear();
      currentGoalMonth = date.getMonth() + 1;
      loadMonthlyGoal();
    } else {
      currentOffset += direction;
      loadGraph();
      if (currentGraphType === 'incident_by_location' && currentLocation) loadLocationTrendGraph();
    }
  }

  // グラフデータを読み込み
  function loadGraph() {
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('chart-container').classList.add('hidden');
    document.getElementById('monthly-goal-container').classList.add('hidden');
    document.getElementById('error-message').classList.add('hidden');

    let url = `/analysis/api/graph-data/?graph_type=${currentGraphType}&period=${currentPeriod}&offset=${currentOffset}&scope=${currentScope}`;

    if (currentGraphType === 'incident_by_location' && currentGenre) {
      url += `&genre=${currentGenre}`;
    }

    fetch(url)
      .then(response => {
        if (!response.ok) throw new Error('データの取得に失敗しました');
        return response.json();
      })
      .then(data => {
        document.getElementById('period-label').textContent = data.period_label;
        drawChart(data);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('chart-container').classList.remove('hidden');
        document.getElementById('analytics-chart').classList.remove('hidden');
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error-message').textContent = 'データの読み込みに失敗しました: ' + error.message;
        document.getElementById('error-message').classList.remove('hidden');
      });
  }

  // グラフ描画
  function drawChart(data) {
    const ctx = document.getElementById('analytics-chart').getContext('2d');

    if (currentChart) currentChart.destroy();

    const hasDatasets = data.datasets !== undefined;
    const chartKind = data.chart_kind || (hasDatasets ? 'bar' : 'line');
    const chartType = chartKind;

    // 比較モード（差分表示）の判定
    const isComparisonMode = data.is_comparison === true;

    const isStackedChart = (chartType === 'bar' && hasDatasets && !isComparisonMode);

    let datasets;

    if (chartKind === 'bar' && hasDatasets) {
      if (isComparisonMode) {
        // 比較モード：差分表示用の設定
        datasets = data.datasets.map((dataset) => {
          const baseColor = dataset.backgroundColor;
          const gradient = ctx.createLinearGradient(0, 0, 0, 400);
          let gradientApplied = false;

          if (typeof baseColor === 'string') {
            const rgbaMatch = baseColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
            if (rgbaMatch) {
              const r = rgbaMatch[1], g = rgbaMatch[2], b = rgbaMatch[3];
              gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.9)`);
              gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0.6)`);
              gradientApplied = true;
            }
          }

          return {
            ...dataset,
            backgroundColor: gradientApplied ? gradient : baseColor,
            borderWidth: 0,
            borderRadius: 0,
            borderSkipped: false,
            barPercentage: 0.95,
            categoryPercentage: 0.95
          };
        });
      } else {
        datasets = data.datasets.map((dataset) => {
          const gradient = ctx.createLinearGradient(0, 0, 0, 400);
          const baseColor = dataset.backgroundColor;
          let gradientApplied = false;

          if (typeof baseColor === 'string') {
            const rgbaMatch = baseColor.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
            if (rgbaMatch) {
              const r = rgbaMatch[1], g = rgbaMatch[2], b = rgbaMatch[3];
              gradient.addColorStop(0, `rgba(${r}, ${g}, ${b}, 0.9)`);
              gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0.6)`);
              gradientApplied = true;
            }
          }

          return {
            ...dataset,
            backgroundColor: gradientApplied ? gradient : baseColor,
            borderWidth: 0,
            borderRadius: 0,
            borderSkipped: false,
            barPercentage: 0.95,
            categoryPercentage: 0.95,
            maxBarThickness: 60
          };
        });
      }
    } else if (chartKind === 'line' && hasDatasets) {
      // 月表示の場合は点を非表示にする（データ点が多くて見づらいため）
      const hidePoints = currentPeriod === 'month';
      datasets = data.datasets.map((dataset) => {
        const border = dataset.borderColor || 'rgb(13, 148, 136)'; // teal-600
        let bg = dataset.backgroundColor || border;
        if (typeof bg === 'string' && bg.startsWith('rgb(')) {
          bg = bg.replace('rgb', 'rgba').replace(')', ', 0.08)');
        }
        return {
          ...dataset,
          borderColor: border,
          backgroundColor: bg,
          fill: false,
          tension: dataset.tension !== undefined ? dataset.tension : 0.3,
          pointRadius: hidePoints ? 0 : (dataset.pointRadius !== undefined ? dataset.pointRadius : 3),
        };
      });
    } else {
      // 月表示の場合は点を非表示にする（データ点が多くて見づらいため）
      const hidePoints = currentPeriod === 'month';
      datasets = [{
        label: data.title,
        data: data.data,
        borderColor: 'rgb(13, 148, 136)',       // teal-600
        backgroundColor: 'rgba(13, 148, 136, 0.10)',
        tension: 0.3,
        fill: true,
        borderWidth: 2,
        pointRadius: hidePoints ? 0 : 4,
        pointBackgroundColor: 'rgb(13, 148, 136)',
      }];
    }

    let yStepSize = currentGraphType === 'sales' ? 100000 : (currentGraphType === 'customer_count' ? 100 : 1);
    if (isComparisonMode && chartType === 'bar' && currentGraphType !== 'sales' && currentGraphType !== 'customer_count') {
      yStepSize = 0.5;
    }

    // 比較モードの場合、Y軸の範囲を計算
    let yAxisConfig = {
      stacked: isStackedChart,  // 比較モードでは積み上げない
      beginAtZero: !isComparisonMode,
      grid: {
        color: function(context) {
          if (isComparisonMode && context.tick.value === 0) {
            return 'rgba(0, 0, 0, 0.3)'; // ゼロラインを強調
          }
          return 'rgba(0, 0, 0, 0.06)';
        },
        lineWidth: function(context) {
          if (isComparisonMode && context.tick.value === 0) {
            return 2; // ゼロラインを太く
          }
          return 1;
        },
        drawBorder: false
      },
      ticks: {
        stepSize: yStepSize,
        font: { size: 11 },
        callback: function(value) {
          // 比較モードで0の場合は「平均」と表示
          if (isComparisonMode && value === 0) return '平均';
          if (currentGraphType === 'sales') return '¥' + value.toLocaleString();
          if (yStepSize < 1) return value.toString();
          return value;
        }
      },
      title: {
        display: currentGraphType === 'incident_by_location',
        text: '（件）',
        font: { size: 12 }
      }
    };

    if (!isComparisonMode) {
      yAxisConfig.min = 0;
    }

    currentChart = new Chart(ctx, {
      type: chartType,
      data: { labels: data.labels, datasets: datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: currentGraphType === 'incident_by_location' ? false : true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              pointStyle: 'circle',
              padding: 15,
              font: { size: 12, weight: '500' }
            }
          },
          title: {
            display: true,
            text: data.title,
            font: { size: 18, weight: 'bold' },
            padding: { top: 10, bottom: 20 }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            cornerRadius: 8,
            titleFont: { size: 14, weight: 'bold' },
            bodyFont: { size: 13 },
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) label += ': ';
                if (context.parsed.y !== null) label += context.parsed.y;
                return label;
              }
            }
          }
        },
        scales: {
          x: {
            stacked: isStackedChart,  // 比較モードでは積み上げない
            grid: { display: false },
            ticks: { font: { size: 11 } }
          },
          y: yAxisConfig
        }
      }
    });
  }

  // 場所別インシデント推移グラフを読み込み
  function loadLocationTrendGraph() {
    document.getElementById('location-trend-loading').classList.remove('hidden');
    document.getElementById('location-trend-chart-container').classList.add('hidden');

    let url = `/analysis/api/graph-data/?graph_type=incident_trend_by_location&period=${currentPeriod}&offset=${currentOffset}&location=${currentLocation}&scope=${currentScope}`;
    if (currentGenre) url += `&genre=${currentGenre}`;

    fetch(url)
      .then(response => {
        if (!response.ok) throw new Error('データの取得に失敗しました');
        return response.json();
      })
      .then(data => {
        drawLocationTrendChart(data);
        document.getElementById('location-trend-loading').classList.add('hidden');
        document.getElementById('location-trend-chart-container').classList.remove('hidden');
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('location-trend-loading').classList.add('hidden');
      });
  }

  // 場所別インシデント推移グラフを描画
  function drawLocationTrendChart(data) {
    const ctx = document.getElementById('location-trend-chart').getContext('2d');

    if (locationTrendChart) locationTrendChart.destroy();

    // datasetsがある場合（比較モード）とない場合（従来モード）で分岐
    let datasets;
    if (data.datasets) {
      // 比較モード：サーバーから返されたdatasetsをそのまま使用
      datasets = data.datasets;
    } else {
      // 従来モード：単一の折れ線
      datasets = [{
        label: data.title,
        data: data.data,
        borderColor: 'rgb(13, 148, 136)',
        backgroundColor: 'rgba(13, 148, 136, 0.10)',
        borderWidth: 2,
        tension: 0.4,
        fill: true,
        pointRadius: 0
      }];
    }

    locationTrendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: true, position: 'top' },
          title: { display: true, text: data.title }
        },
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1 } }
        }
      }
    });
  }

  // 月次目標を読み込み
  function loadMonthlyGoal() {
    if (currentChart) {
      currentChart.destroy();
      currentChart = null;
    }

    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('chart-container').classList.add('hidden');
    document.getElementById('analytics-chart').classList.add('hidden');
    document.getElementById('monthly-goal-container').classList.add('hidden');
    document.getElementById('error-message').classList.add('hidden');

    const today = new Date();
    if (currentGoalYear === null || currentGoalMonth === null) {
      currentGoalYear = today.getFullYear();
      currentGoalMonth = today.getMonth() + 1;
    }

    const year = currentGoalYear;
    const month = currentGoalMonth;

    document.getElementById('period-label').textContent = `${year}年${month}月`;

    fetch(`/analysis/api/monthly-goal/?year=${year}&month=${month}`)
      .then(response => {
        if (!response.ok) {
          return response.text().then(text => {
            throw new Error(`目標データの取得に失敗しました (${response.status}): ${text}`);
          });
        }
        return response.json();
      })
      .then(data => {
        document.getElementById('goal-text').textContent = data.goal_text;

        const bar = document.getElementById('achievement-bar');

        if (data.goal_text === '目標が設定されていません') {
          document.getElementById('achievement-rate').textContent = '-';
          bar.style.width = '0%';
          document.getElementById('achievement-text').textContent = '管理者に目標の設定を依頼してください';

          bar.classList.remove('bg-emerald-500', 'bg-amber-400');
          bar.classList.add('bg-teal-600');
        } else {
          const rate = data.achievement_rate;
          document.getElementById('achievement-rate').textContent = rate + '%';
          bar.style.width = rate + '%';

          // 色（統一：teal / amber / emerald）
          bar.classList.remove('bg-teal-600', 'bg-amber-400', 'bg-emerald-500');
          if (rate >= 80) {
            bar.classList.add('bg-emerald-500');
          } else if (rate >= 50) {
            bar.classList.add('bg-amber-400');
          } else {
            bar.classList.add('bg-teal-600');
          }

          document.getElementById('achievement-text').textContent = data.achievement_text;
        }

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('monthly-goal-container').classList.remove('hidden');
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('error-message').textContent = '目標データの読み込みに失敗しました: ' + error.message;
        document.getElementById('error-message').classList.remove('hidden');
      });
  }

  // 初期ロード
  document.addEventListener('DOMContentLoaded', function() {
    const graphTypeSelect = document.getElementById('graph-type');
    graphTypeSelect.value = currentGraphType;

    const genreFilter = document.getElementById('genre-filter');
    genreFilter.value = currentGenre;

    const genreFilterWrap = document.getElementById('genre-filter-wrap');

    if (currentGraphType === 'incident_by_location') {
      genreFilterWrap.classList.remove('hidden');
      document.getElementById('location-trend-section').classList.remove('hidden');
    } else {
      genreFilterWrap.classList.add('hidden');
    }

    // 期間ラジオボタン復元
    const periodWeek = document.getElementById('period-week');
    const periodMonth = document.getElementById('period-month');
    const periodPreview = document.getElementById('period-preview');
    if (currentPeriod === 'week') periodWeek.checked = true;
    else if (currentPeriod === 'month') periodMonth.checked = true;
    else periodPreview.checked = true;

    // スコープ復元
    const scopeOwn = document.getElementById('scope-own');
    const scopeAll = document.getElementById('scope-all');
    if (currentScope === 'all') scopeAll.checked = true;
    else scopeOwn.checked = true;

    // 月次目標の場合は週/月/プレビューと全店舗ラジオボタンを非表示
    const periodSelector = document.getElementById('period-selector');
    const scopeSelector = document.getElementById('scope-selector');
    if (currentGraphType === 'monthly_goal') {
      if (periodSelector) periodSelector.classList.add('hidden');
      if (scopeSelector) scopeSelector.classList.add('hidden');
      loadMonthlyGoal();
      return;
    }

    // プレビュー（場所別インシデントのみ）
    if (currentPeriod === 'preview' && currentGraphType === 'incident_by_location') {
      const mainGraphContainer = document.getElementById('mainGraphCard');
      if (mainGraphContainer) mainGraphContainer.style.display = 'none';
      loadLocationTrendGraph();
      return;
    }

    loadGraph();
    if (currentGraphType === 'incident_by_location') {
      loadLocationTrendGraph();
    }
  });
</script>
{% endblock %}
