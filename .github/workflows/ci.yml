name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_DB: c3_app_test
          POSTGRES_USER: c3
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run migrations
      env:
        SECRET_KEY: test-secret-key-for-ci-only
        DEBUG: False
        DATABASE_URL: postgresql://c3:password@localhost:5432/c3_app_test
        ALLOWED_HOSTS: localhost,127.0.0.1
      run: |
        python manage.py migrate

    - name: Run tests
      env:
        SECRET_KEY: test-secret-key-for-ci-only
        DEBUG: False
        DATABASE_URL: postgresql://c3:password@localhost:5432/c3_app_test
        ALLOWED_HOSTS: localhost,127.0.0.1
      run: |
        python manage.py test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Deploy to Render
      id: deploy
      env:
        RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
      run: |
        if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
          echo "Error: RENDER_DEPLOY_HOOK_URL is not set"
          echo "Please add it to GitHub Secrets: Settings -> Secrets and variables -> Actions"
          exit 1
        fi
        echo "Triggering Render deployment..."
        curl -X POST "$RENDER_DEPLOY_HOOK_URL"
        echo "Deployment triggered successfully!"

    - name: Notify Slack
      if: always()
      uses: slackapi/slack-github-action@v1.26.0
      with:
        payload: |
          {
            "text": "${{ steps.deploy.outcome == 'success' && '‚úÖ Deploy Success' || '‚ùå Deploy Failed' }}",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "${{ steps.deploy.outcome == 'success' && '‚úÖ Deployment Successful' || '‚ùå Deployment Failed' }}"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Repository:*\n${{ github.repository }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Branch:*\n${{ github.ref_name }}"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Tests:*\n‚úÖ Passed"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Deploy:*\n${{ steps.deploy.outcome == 'success' && 'üöÄ Triggered' || 'üí• Failed' }}"
                  }
                ]
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Commit:* <${{ github.event.head_commit.url }}|${{ github.event.head_commit.message }}>\n*Author:* ${{ github.event.head_commit.author.name }}"
                }
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*App URL:* https://c3-app.onrender.com"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
