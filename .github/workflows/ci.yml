name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_DB: c3_app_test
          POSTGRES_USER: c3
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run migrations
      env:
        SECRET_KEY: test-secret-key-for-ci-only
        DEBUG: False
        DATABASE_URL: postgresql://c3:password@localhost:5432/c3_app_test
        ALLOWED_HOSTS: localhost,127.0.0.1
      run: |
        python manage.py migrate

    - name: Run tests
      env:
        SECRET_KEY: test-secret-key-for-ci-only
        DEBUG: False
        DATABASE_URL: postgresql://c3:password@localhost:5432/c3_app_test
        ALLOWED_HOSTS: localhost,127.0.0.1
      run: |
        python manage.py test

    - name: Prepare commit message
      if: failure() && github.event_name == 'push'
      id: commit_msg_failed
      run: |
        COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
        echo "message=${COMMIT_MSG}" >> $GITHUB_OUTPUT

    - name: Notify Slack - Test Failed
      if: failure() && github.event_name == 'push'
      uses: slackapi/slack-github-action@v1.26.0
      with:
        payload: |
          {
            "text": "ğŸ• ${{ github.event.head_commit.timestamp }}\n\nâŒ Tests Failed\n\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Tests:* âŒ Failed\n*Deploy:* â¸ï¸ Skipped\n\n*Commit:* ${{ steps.commit_msg_failed.outputs.message }}\n*Author:* ${{ github.event.head_commit.author.name }}\n\n*Action:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Deploy to Render
      id: deploy
      env:
        RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
      run: |
        if [ -z "$RENDER_DEPLOY_HOOK_URL" ]; then
          echo "Error: RENDER_DEPLOY_HOOK_URL is not set"
          echo "Please add it to GitHub Secrets: Settings -> Secrets and variables -> Actions"
          exit 1
        fi
        echo "Triggering Render deployment..."
        curl -X POST "$RENDER_DEPLOY_HOOK_URL"
        echo "Deployment triggered successfully!"

    - name: Prepare commit message
      if: always()
      id: commit_msg
      run: |
        COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1)
        echo "message=${COMMIT_MSG}" >> $GITHUB_OUTPUT

    - name: Notify Slack
      if: always()
      uses: slackapi/slack-github-action@v1.26.0
      with:
        payload: |
          {
            "text": "ğŸ• ${{ github.event.head_commit.timestamp }}\n\n${{ steps.deploy.outcome == 'success' && 'âœ… Deployment Successful' || 'âŒ Deployment Failed' }}\n\n*Repository:* ${{ github.repository }}\n*Branch:* ${{ github.ref_name }}\n*Tests:* âœ… Passed\n*Deploy:* ${{ steps.deploy.outcome == 'success' && 'ğŸš€ Triggered' || 'ğŸ’¥ Failed' }}\n\n*Commit:* ${{ steps.commit_msg.outputs.message }}\n*Author:* ${{ github.event.head_commit.author.name }}\n\n*URL:* https://c3-ekeu.onrender.com/"
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
