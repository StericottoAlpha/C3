{% extends 'base.html' %}
{% load humanize %}

{% block title %}日報一覧 - C3 ステリコットα{% endblock %}

{% block content %}

<!-- ✅ 背景（ホーム風：単色・グラデ無し） -->
<div aria-hidden="true"
     class="fixed inset-0 -z-10 overflow-hidden pointer-events-none"
     style="background:#c8d8d6;">
</div>

<div class="min-h-screen py-6 px-4 pb-28">
  <div class="max-w-6xl mx-auto">

    <!-- 外枠フレーム（シンプル） -->
    <div class="rounded-3xl border border-gray-200 bg-white/75 backdrop-blur-[1px] shadow-sm p-5 sm:p-6">

      <!-- ヘッダー -->
      <div class="flex items-center justify-between gap-3 mb-6">
        <div>
          <p class="text-xs text-gray-500">日報</p>
          <h1 class="text-xl sm:text-2xl font-extrabold text-gray-900">日報一覧</h1>
          <p class="text-sm text-gray-600 mt-1">日別のまとめや検索で確認できます。</p>
        </div>

        <a href="{% url 'reports:register' %}?next={% url 'reports:list' %}"
           class="inline-flex items-center gap-2 rounded-xl bg-teal-600 px-4 py-2 text-sm font-semibold text-white
                  shadow hover:bg-teal-700 transition">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 5a1 1 0 0 1 1 1v5h5a1 1 0 1 1 0 2h-5v5a1 1 0 1 1-2 0v-5H6a1 1 0 1 1 0-2h5V6a1 1 0 0 1 1-1z"/>
          </svg>
          新規作成
        </a>
      </div>

      <!-- タブ -->
      <div class="mb-5">
        <div class="inline-flex rounded-2xl border border-gray-200 bg-gray-50 p-1">
          <button type="button" id="tab-daily" onclick="switchTab('daily')"
                  class="tab-button px-4 py-2 rounded-xl text-sm font-semibold transition
                         bg-teal-600 text-white shadow-sm border border-teal-600">
            日別表示
          </button>
          <button type="button" id="tab-search" onclick="switchTab('search')"
                  class="tab-button px-4 py-2 rounded-xl text-sm font-semibold transition
                         bg-white text-gray-700 border border-transparent hover:bg-gray-100">
            検索表示
          </button>
        </div>
      </div>

      <!-- 日別表示 -->
      <div id="content-daily" class="tab-content">
        {% if reports_by_date %}
          <div class="space-y-4">
            {% for day_data in reports_by_date %}
              <div class="rounded-2xl border border-gray-200 bg-white shadow-sm overflow-hidden">

                <!-- 日付ヘッダー -->
                <button type="button"
                        onclick="toggleDayAccordion('day-{{ forloop.counter }}')"
                        class="w-full flex items-center justify-between p-4 sm:p-5 hover:bg-gray-50 transition">
                  <div class="flex items-center gap-3">
                    <div class="text-left">
                      <h2 class="text-base sm:text-lg font-extrabold text-gray-900">
                        {{ day_data.date|date:"Y年m月d日 (D)" }}
                      </h2>
                      <p class="text-xs text-gray-500 mt-0.5">この日の記録</p>
                    </div>
                    <span class="text-xs bg-teal-100 text-teal-700 px-3 py-1 rounded-full font-bold">
                      {{ day_data.count }}件
                    </span>
                  </div>

                  <svg id="icon-day-{{ forloop.counter }}"
                       class="w-6 h-6 text-gray-400 transform transition-transform duration-200"
                       fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </button>

                <!-- 中身 -->
                <div id="day-{{ forloop.counter }}" class="accordion-content hidden bg-gray-50 border-t border-gray-200">
                  <div class="p-4 sm:p-5 space-y-4">

                    <!-- 店舗実績 -->
                    {% if day_data.performance %}
                      <div class="rounded-2xl border border-teal-200 bg-white p-4">
                        <div class="flex items-center justify-between mb-3">
                          <h3 class="text-sm font-extrabold text-teal-700">店舗実績</h3>
                          <span class="text-xs text-gray-500">当日の数値</span>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                          <div class="rounded-xl border border-gray-200 bg-gray-50 p-3 text-center">
                            <p class="text-xs text-gray-500 mb-1">売上金額</p>
                            <p class="text-lg font-extrabold text-gray-900">
                              ¥{{ day_data.performance.sales_amount|intcomma|default:"--" }}
                            </p>
                          </div>

                          <div class="rounded-xl border border-gray-200 bg-gray-50 p-3 text-center">
                            <p class="text-xs text-gray-500 mb-1">客数</p>
                            <p class="text-lg font-extrabold text-gray-900">
                              {{ day_data.performance.customer_count|intcomma|default:"--" }}
                              <span class="text-sm text-gray-500">人</span>
                            </p>
                          </div>

                          <div class="rounded-xl border border-gray-200 bg-gray-50 p-3 text-center">
                            <p class="text-xs text-gray-500 mb-1">違算金額</p>
                            <p class="text-lg font-extrabold {% if day_data.performance.cash_difference == 0 %}text-emerald-600{% else %}text-red-600{% endif %}">
                              {% if day_data.performance.cash_difference > 0 %}+{% endif %}¥{{ day_data.performance.cash_difference|intcomma|default:"--" }}
                            </p>
                          </div>
                        </div>
                      </div>
                    {% else %}
                      <div class="rounded-2xl border border-amber-200 bg-amber-50 p-3 text-center">
                        <p class="text-sm text-amber-800 font-semibold">この日の店舗実績データは未登録です</p>
                      </div>
                    {% endif %}

                    <!-- 日報一覧 -->
                    <div class="space-y-3">
                      {% for report in day_data.reports %}
                        <a href="{% url 'reports:view' report.report_id %}"
                           class="block rounded-2xl border border-gray-200 bg-white p-4 hover:border-teal-500 hover:shadow-sm transition">
                          <div class="flex items-start justify-between gap-4">
                            <div class="min-w-0 flex-1">
                              <div class="flex flex-wrap items-center gap-2 mb-2">
                                <span class="text-xs font-bold bg-gray-100 text-gray-700 px-2 py-1 rounded">
                                  {{ report.get_genre_display }}
                                </span>
                                <span class="text-xs font-bold bg-sky-100 text-sky-700 px-2 py-1 rounded">
                                  {{ report.get_location_display }}
                                </span>
                                {% if report.post_to_bbs %}
                                  <span class="text-xs bg-teal-100 text-teal-700 px-2 py-1 rounded font-bold">
                                    掲示板連携
                                  </span>
                                {% endif %}
                              </div>

                              <h3 class="text-base sm:text-lg font-extrabold text-gray-900 mb-1 break-words">
                                {{ report.title }}
                              </h3>

                              <p class="text-sm text-gray-700 line-clamp-2">
                                {{ report.content|truncatechars:100 }}
                              </p>

                              <div class="mt-2 flex items-center gap-3 text-xs text-gray-500">
                                <span class="font-semibold text-gray-700">{{ report.user.username }}</span>
                                <span>{{ report.created_at|date:"H:i" }}</span>
                              </div>
                            </div>
                          </div>
                        </a>
                      {% endfor %}
                    </div>

                  </div>
                </div>

              </div>
            {% endfor %}
          </div>

        {% else %}
          <div class="text-center py-12">
            <p class="text-gray-700 text-lg font-bold">まだ日報がありません</p>
            <p class="text-gray-600 mt-2">最初の日報を作成してみましょう</p>
          </div>
        {% endif %}
      </div>

      <!-- 検索表示 -->
      <div id="content-search" class="tab-content hidden">

        <div class="mb-5 rounded-2xl border border-gray-200 bg-white p-4 sm:p-5">
          <form method="get" action="" class="space-y-3">
            <input type="hidden" name="view" value="search">

            <div class="flex flex-col sm:flex-row gap-2">
              <input type="text" name="query" value="{{ query|default:'' }}"
                     placeholder="キーワードを入力（デフォルトではor検索）"
                     class="w-full flex-1 border border-gray-300 rounded-xl px-4 py-2.5 text-sm
                            focus:outline-none focus:ring-2 focus:ring-teal-300 focus:border-transparent bg-white">
              <button type="submit"
                      class="inline-flex items-center justify-center rounded-xl bg-teal-600 px-6 py-2.5 text-sm font-extrabold text-white
                             shadow hover:bg-teal-700 transition">
                検索
              </button>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
              <select name="genre" onchange="this.form.submit()"
                      class="w-full bg-white border border-gray-300 text-gray-700 py-2.5 px-3 rounded-xl text-sm
                             focus:outline-none focus:ring-2 focus:ring-teal-300 focus:border-transparent">
                <option value="">全てのジャンル</option>
                {% for code, label in genre_choices %}
                  <option value="{{ code }}" {% if current_genre == code %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>

              <select name="location" onchange="this.form.submit()"
                      class="w-full bg-white border border-gray-300 text-gray-700 py-2.5 px-3 rounded-xl text-sm
                             focus:outline-none focus:ring-2 focus:ring-teal-300 focus:border-transparent">
                <option value="">全ての場所</option>
                {% for code, label in location_choices %}
                  <option value="{{ code }}" {% if current_location == code %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>

              <select name="sort" onchange="this.form.submit()"
                      class="w-full bg-white border border-gray-300 text-gray-700 py-2.5 px-3 rounded-xl text-sm
                             focus:outline-none focus:ring-2 focus:ring-teal-300 focus:border-transparent">
                <option value="newest" {% if sort == 'newest' %}selected{% endif %}>日付: 新しい順</option>
                <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>日付: 古い順</option>
              </select>
            </div>
          </form>
        </div>

        {% if reports %}
          <div class="space-y-3">
            {% for report in reports %}
              <a href="{% url 'reports:view' report.report_id %}"
                 class="block rounded-2xl border border-gray-200 bg-white p-4 hover:border-teal-500 hover:shadow-sm transition">
                <div class="flex flex-wrap items-center justify-between gap-3">
                  <div class="flex flex-wrap items-center gap-2 min-w-0">
                    <span class="text-xs font-bold bg-gray-100 text-gray-700 px-2 py-1 rounded">
                      {{ report.get_genre_display }}
                    </span>
                    <span class="text-xs font-bold bg-sky-100 text-sky-700 px-2 py-1 rounded">
                      {{ report.get_location_display }}
                    </span>
                    <h2 class="text-base sm:text-lg font-extrabold text-gray-900 break-words">
                      {{ report.title }}
                    </h2>
                  </div>

                  <span class="text-xs text-gray-500 whitespace-nowrap">
                    {{ report.date|date:"Y/m/d" }}
                  </span>
                </div>

                <p class="mt-2 text-sm text-gray-700 line-clamp-2">
                  {{ report.content|truncatechars:100 }}
                </p>

                <div class="mt-3 flex flex-wrap items-center justify-between gap-2 text-xs text-gray-500">
                  <div class="flex flex-wrap items-center gap-3">
                    <span class="font-semibold text-gray-700">{{ report.user.username }}</span>

                    {% if report.store and report.store.store_name %}
                      <span>{{ report.store.store_name }}</span>
                    {% endif %}

                    {% if report.post_to_bbs %}
                      <span class="text-xs bg-teal-100 text-teal-700 px-2 py-1 rounded font-bold">掲示板連携</span>
                    {% endif %}
                  </div>
                </div>
              </a>
            {% endfor %}
          </div>

        {% else %}
          <div class="text-center py-12">
            <p class="text-gray-700 text-lg font-bold">まだ日報がありません</p>
            <p class="text-gray-600 mt-2">最初の日報を作成してみましょう</p>
          </div>
        {% endif %}
      </div>

    </div>
  </div>
</div>

<script>
// タブ切り替え機能（デザインに合わせて class を切り替え）
function switchTab(tabName) {
  const tabDaily = document.getElementById('tab-daily');
  const tabSearch = document.getElementById('tab-search');

  // コンテンツ非表示
  document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));

  // ボタン状態をリセット
  [tabDaily, tabSearch].forEach(btn => {
    btn.classList.remove('bg-teal-600','text-white','border-teal-600','shadow-sm');
    btn.classList.add('bg-white','text-gray-700','border-transparent');
  });

  // アクティブ
  const activeBtn = document.getElementById(`tab-${tabName}`);
  activeBtn.classList.add('bg-teal-600','text-white','border-teal-600','shadow-sm');
  activeBtn.classList.remove('bg-white','text-gray-700','border-transparent');

  // 表示
  document.getElementById(`content-${tabName}`).classList.remove('hidden');

  localStorage.setItem('reportsActiveTab', tabName);
}

// アコーディオン
function toggleDayAccordion(dayId) {
  const content = document.getElementById(dayId);
  const icon = document.getElementById(`icon-${dayId}`);

  if (content.classList.contains('hidden')) {
    content.classList.remove('hidden');
    icon.classList.add('rotate-180');
  } else {
    content.classList.add('hidden');
    icon.classList.remove('rotate-180');
  }
}

// 初期復元
document.addEventListener('DOMContentLoaded', function() {
  const savedTab = localStorage.getItem('reportsActiveTab') || 'daily';
  switchTab(savedTab);
});
</script>

{% endblock %}
