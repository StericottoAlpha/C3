# Act 02: ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢åŸºç›¤å®Ÿè£…ï¼ˆPhase 2 Part 1ï¼‰

**å®Ÿè£…æ—¥**: 2025å¹´12æœˆ10æ—¥
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸš§ é€²è¡Œä¸­ï¼ˆ30%å®Œäº†ï¼‰

---

## æ¦‚è¦

Phase 2ã®ãƒ„ãƒ¼ãƒ«å®Ÿè£…ã«å‘ã‘ã¦ã€ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®å¿ƒè‡“éƒ¨ã¨ãªã‚‹**VectorSearchService**ã¨**QueryClassifier**ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€PgVectorã‚’ä½¿ç”¨ã—ãŸã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦æ¤œç´¢ã¨ã‚¯ã‚¨ãƒªã®æ€§è³ªåˆ†æãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

---

## å®Ÿè£…å†…å®¹

### 1. VectorSearchService (ai_features/services.py)

#### search_documents() - å®Ÿç¸¾RAGæ¤œç´¢
```python
@classmethod
def search_documents(
    cls,
    query: str,
    user,
    source_types: Optional[List[str]] = None,
    filters: Optional[Dict] = None,
    top_k: int = 5
) -> List[Dict]:
    """
    DocumentVectorã‹ã‚‰å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢

    Args:
        query: æ¤œç´¢ã‚¯ã‚¨ãƒª
        user: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆåº—èˆ—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨ï¼‰
        source_types: ['daily_report', 'bbs_post', 'bbs_comment']
        filters: {
            'date': '2025-12-10',
            'date_from': '2025-12-01',
            'date_to': '2025-12-31',
            'genre': 'claim',
            'user_id': 'S001'
        }
        top_k: å–å¾—ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 5ï¼‰

    Returns:
        [
            {
                'vector_id': 123,
                'source_type': 'daily_report',
                'source_id': 45,
                'content': '12æœˆ9æ—¥ã€ãƒ›ãƒ¼ãƒ«æ–™ç†æä¾›é…å»¶...',
                'metadata': {...},
                'similarity': 0.92
            },
            ...
        ]
    """
```

**å®Ÿè£…ã®ç‰¹å¾´**:
- âœ… ã‚¯ã‚¨ãƒªã®è‡ªå‹•ãƒ™ã‚¯ãƒˆãƒ«åŒ–
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼åº—èˆ—ã§ã®è‡ªå‹•ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- âœ… æŸ”è»Ÿãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæ—¥ä»˜ã€ã‚¸ãƒ£ãƒ³ãƒ«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç­‰ï¼‰
- âœ… PgVectorã®ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦æ¤œç´¢ï¼ˆ`<=>` æ¼”ç®—å­ï¼‰
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**SQLä¾‹**:
```sql
SELECT
    vector_id,
    source_type,
    source_id,
    content,
    metadata,
    1 - (embedding <=> $1::vector) AS similarity
FROM document_vectors
WHERE metadata->>'store_id' = $2
  AND metadata->>'date' = $3
  AND metadata->>'genre' = $4
ORDER BY embedding <=> $5::vector
LIMIT $6
```

#### search_knowledge() - ãƒŠãƒ¬ãƒƒã‚¸RAGæ¤œç´¢
```python
@classmethod
def search_knowledge(
    cls,
    query: str,
    category: Optional[str] = None,
    document_type: Optional[str] = None,
    top_k: int = 3
) -> List[Dict]:
    """
    KnowledgeVectorã‹ã‚‰ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ»è¦å‰‡ã‚’æ¤œç´¢

    Args:
        query: æ¤œç´¢ã‚¯ã‚¨ãƒª
        category: 'hygiene' | 'service' | 'cooking' | 'safety' | 'other'
        document_type: 'manual' | 'guideline' | 'faq' | 'policy'
        top_k: å–å¾—ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3ï¼‰

    Returns:
        [
            {
                'vector_id': 456,
                'document_id': 1,
                'document_type': 'manual',
                'content': 'ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼æ—¥æ¬¡ç‚¹æ¤œæ‰‹é †...',
                'metadata': {
                    'category': 'cooking',
                    'document_title': 'èª¿ç†æ©Ÿå™¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«',
                    'chapter': 'ç¬¬5ç« ',
                    'section': '5.2 ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼ç®¡ç†'
                },
                'similarity': 0.95
            },
            ...
        ]
    """
```

**å®Ÿè£…ã®ç‰¹å¾´**:
- âœ… ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆè¡›ç”Ÿç®¡ç†ã€æ¥å®¢ã€èª¿ç†ç­‰ï¼‰
- âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- âœ… ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç‰¹æœ‰ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ´»ç”¨
- âœ… å®Ÿç¸¾RAGã‚ˆã‚Šå°‘ãªã‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆTop-Kï¼ˆ3ä»¶ï¼‰

### 2. QueryClassifier (ai_features/services.py)

#### classify_and_get_top_k() - å‹•çš„Top-Kæ±ºå®š
```python
@classmethod
def classify_and_get_top_k(cls, query: str) -> int:
    """
    ã‚¯ã‚¨ãƒªã®æ€§è³ªã«å¿œã˜ã¦Top-Kå€¤ã‚’æ±ºå®š

    ä¾‹:
        "2025-12-09ã®â—‹â—‹åº—ã®ã‚¯ãƒ¬ãƒ¼ãƒ " â†’ 3ä»¶ï¼ˆæ˜ç¢ºãªäº‹ä¾‹æ¤œç´¢ï¼‰
        "ã‚¯ãƒ¬ãƒ¼ãƒ ã®å‚¾å‘" â†’ 12ä»¶ï¼ˆãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æï¼‰
        "å…¨ã¦ã®æ—¥å ±" â†’ 20ä»¶ï¼ˆåŒ…æ‹¬çš„èª¿æŸ»ï¼‰
    """
```

**åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯**:
| ã‚¯ã‚¨ãƒªã‚¿ã‚¤ãƒ— | ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ | Top-K | ç”¨é€” |
|-------------|-----------|-------|------|
| ç‰¹å®šäº‹ä¾‹æ¤œç´¢ | åº—ã€æ—¥ã€æœˆã€ID | 3 | æ˜ç¢ºãªã‚¯ã‚¨ãƒª |
| ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ | å‚¾å‘ã€å¤šã„ã€å¢—åŠ ã€æ¸›å°‘ã€æ¨ç§» | 12 | å‚¾å‘æŠŠæ¡ |
| åŒ…æ‹¬çš„èª¿æŸ» | å…¨ã¦ã€ä¸€è¦§ã€ã™ã¹ã¦ã€å…¨ä½“ | 20 | å…¨ä½“åƒæŠŠæ¡ |
| ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | - | 5 | ä¸€èˆ¬çš„ãªæ¤œç´¢ |

#### is_ambiguous() - æ›–æ˜§æ€§åˆ¤å®š
```python
@classmethod
def is_ambiguous(cls, query: str) -> bool:
    """
    ã‚¯ã‚¨ãƒªãŒæ›–æ˜§ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆQuery Expansionè¦å¦åˆ¤æ–­ï¼‰

    æ›–æ˜§ãªä¾‹:
        "æ˜¨æ—¥ã®å•é¡Œ" â†’ Trueï¼ˆæ™‚é–“è¡¨ç¾ãŒæ›–æ˜§ï¼‰
        "æœ€è¿‘ã®ãƒˆãƒ©ãƒ–ãƒ«" â†’ Trueï¼ˆæ™‚é–“ + æŠ½è±¡çš„ï¼‰
        "ä½è—¤ã•ã‚“ã®ä»¶" â†’ Trueï¼ˆæŠ½è±¡çš„ï¼‰

    æ˜ç¢ºãªä¾‹:
        "2025-12-09ã®ã‚¯ãƒ¬ãƒ¼ãƒ " â†’ Falseï¼ˆå…·ä½“çš„ãªæ—¥ä»˜ï¼‰
        "åº—èˆ—001ã®å£²ä¸Š" â†’ Falseï¼ˆå…·ä½“çš„ãªæŒ‡å®šï¼‰
    """
```

**åˆ¤å®šåŸºæº–**:
1. **æ›–æ˜§ãªæ™‚é–“è¡¨ç¾**: æ˜¨æ—¥ã€å‰æ—¥ã€æœ€è¿‘ã€å…ˆé€±ã€å…ˆæœˆã€ä»Šé€±ã€ä»Šæœˆ
2. **æŠ½è±¡çš„ãªè¡¨ç¾**: å•é¡Œã€ãƒˆãƒ©ãƒ–ãƒ«ã€ä»¶ã€ã“ã¨ã€ã‚‚ã®ã€ã‚„ã¤
   - ãŸã ã—ã€æ•°å­—ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯æ˜ç¢ºã¨åˆ¤å®š

---

## æ¤œç´¢ãƒ•ãƒ­ãƒ¼ã®è©³ç´°

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: æ˜ç¢ºãªã‚¯ã‚¨ãƒªã®ç›´æ¥æ¤œç´¢

```
ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚¨ãƒªã€‘
"2025å¹´12æœˆ9æ—¥ã®â—‹â—‹åº—ã®ã‚¯ãƒ¬ãƒ¼ãƒ "

ã€å‡¦ç†ãƒ•ãƒ­ãƒ¼ã€‘
1. QueryClassifier.is_ambiguous() â†’ Falseï¼ˆæ˜ç¢ºï¼‰
2. QueryClassifier.classify_and_get_top_k() â†’ 3ï¼ˆç‰¹å®šäº‹ä¾‹ï¼‰
3. EmbeddingService.generate_embedding() â†’ 384æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«
4. VectorSearchService.search_documents()
   - ãƒ•ã‚£ãƒ«ã‚¿: store_id, date='2025-12-09', genre='claim'
   - Top-K: 3
5. PgVectoræ¤œç´¢å®Ÿè¡Œ
   - ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦è¨ˆç®—
   - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨
6. çµæœè¿”å´ï¼ˆsimilarityé †ï¼‰

ã€çµæœä¾‹ã€‘
[
  {similarity: 0.92, content: "12æœˆ9æ—¥ãƒ›ãƒ¼ãƒ«æ–™ç†æä¾›30åˆ†é…å»¶..."},
  {similarity: 0.87, content: "9æ—¥å¤•æ–¹ã€ãŠå®¢æ§˜ã‹ã‚‰ã‚¯ãƒ¬ãƒ¼ãƒ ..."},
  {similarity: 0.82, content: "12/9ã‚­ãƒƒãƒãƒ³äººæ‰‹ä¸è¶³..."}
]
```

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: æ›–æ˜§ãªã‚¯ã‚¨ãƒªã®æ‹¡å¼µæ¤œç´¢ï¼ˆæ¬¡å›å®Ÿè£…äºˆå®šï¼‰

```
ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚¨ãƒªã€‘
"æ˜¨æ—¥ä½•ã‹å•é¡Œã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿ"

ã€å‡¦ç†ãƒ•ãƒ­ãƒ¼ã€‘
1. QueryClassifier.is_ambiguous() â†’ Trueï¼ˆæ›–æ˜§ï¼‰
2. QueryExpander.expand() â†’ 3-5å€‹ã®ã‚¯ã‚¨ãƒªç”Ÿæˆ â† æ¬¡å›å®Ÿè£…
   - "2025-12-09 å•é¡Œ"
   - "12/9 ãƒˆãƒ©ãƒ–ãƒ«"
   - "å‰æ—¥ ã‚¯ãƒ¬ãƒ¼ãƒ "
   - "æ˜¨æ—¥ äº‹æ•…"
   - "2025å¹´12æœˆ9æ—¥ ä¸å…·åˆ"
3. å„ã‚¯ã‚¨ãƒªã§ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
4. ResultMerger.merge_and_rank() â† æ¬¡å›å®Ÿè£…
   - é‡è¤‡æ’é™¤
   - ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°: hit_count * 10 + max_similarity
5. Top-5è¿”å´
```

---

## ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã®è§£é‡ˆ

PgVectorã®`<=>`æ¼”ç®—å­ã¯**ã‚³ã‚µã‚¤ãƒ³è·é›¢**ã‚’è¿”ã—ã¾ã™ã€‚
**ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦** = `1 - ã‚³ã‚µã‚¤ãƒ³è·é›¢`

### ã‚¹ã‚³ã‚¢ã®ç›®å®‰

| é¡ä¼¼åº¦ | è§£é‡ˆ | ç”¨é€” |
|--------|------|------|
| 0.9 - 1.0 | ã»ã¼åŒä¸€å†…å®¹ | éå¸¸ã«é–¢é€£ãŒé«˜ã„ |
| 0.8 - 0.9 | å¼·ãé–¢é€£ | é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
| 0.7 - 0.8 | ã‚ã‚‹ç¨‹åº¦é–¢é€£ | å‚è€ƒæƒ…å ± |
| 0.6 - 0.7 | å¼±ãé–¢é€£ | é–¢é€£æ€§ä½ã„ |
| 0.0 - 0.6 | ã»ã¨ã‚“ã©é–¢é€£ãªã— | é€šå¸¸è¿”ã•ãªã„ |

### å®Ÿè£…ã§ã®é–¾å€¤

ç¾åœ¨ã®å®Ÿè£…ã§ã¯é–¾å€¤ã‚’è¨­ã‘ãšã€Top-Kã§ä¸Šä½Nä»¶ã‚’è¿”ã™æ–¹å¼ã€‚
å°†æ¥çš„ã«ã¯æœ€ä½é¡ä¼¼åº¦ï¼ˆä¾‹: 0.6ï¼‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚‚æ¤œè¨å¯èƒ½ã€‚

---

## ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ã®æ´»ç”¨ä¾‹

### å®Ÿç¸¾RAGï¼ˆDocumentVectorï¼‰

#### ä¾‹1: ç‰¹å®šåº—èˆ—ã®å…ˆæœˆã®ã‚¯ãƒ¬ãƒ¼ãƒ 
```python
results = VectorSearchService.search_documents(
    query="æä¾›é…å»¶",
    user=current_user,
    source_types=['daily_report'],
    filters={
        'date_from': '2024-11-01',
        'date_to': '2024-11-30',
        'genre': 'claim'
    },
    top_k=10
)
```

#### ä¾‹2: ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸæ—¥å ±
```python
results = VectorSearchService.search_documents(
    query="æ¥å®¢",
    user=current_user,
    source_types=['daily_report'],
    filters={
        'user_id': 'S001'
    },
    top_k=5
)
```

#### ä¾‹3: ä»Šæ—¥ã®å…¨ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¯ãƒ¬ãƒ¼ãƒ ãƒ»è³è³›ãƒ»äº‹æ•…ï¼‰
```python
results = VectorSearchService.search_documents(
    query="ä»Šæ—¥",
    user=current_user,
    source_types=['daily_report'],
    filters={
        'date': '2025-12-10'
    },
    top_k=20
)
```

### ãƒŠãƒ¬ãƒƒã‚¸RAGï¼ˆKnowledgeVectorï¼‰

#### ä¾‹1: è¡›ç”Ÿç®¡ç†ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®æ¤œç´¢
```python
results = VectorSearchService.search_knowledge(
    query="ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼ç‚¹æ¤œ",
    category='hygiene',
    document_type='manual',
    top_k=3
)
```

#### ä¾‹2: æ¥å®¢ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³å…¨èˆ¬
```python
results = VectorSearchService.search_knowledge(
    query="ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ",
    category='service',
    top_k=5
)
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ç¾åœ¨ã®å®Ÿè£…

- âœ… ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚¨ãƒªã®ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢
- âœ… ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- âœ… JSONBæ¼”ç®—å­ã«ã‚ˆã‚‹é«˜é€Ÿãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹

### å°†æ¥ã®æœ€é©åŒ–ï¼ˆPhase 4äºˆå®šï¼‰

#### 1. IVFFlat ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
```sql
-- ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢é«˜é€ŸåŒ–
CREATE INDEX document_vectors_embedding_idx
ON document_vectors
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);  -- ãƒ‡ãƒ¼ã‚¿é‡ã®âˆšãŒç›®å®‰

-- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ¤œç´¢é«˜é€ŸåŒ–
CREATE INDEX document_vectors_metadata_idx
ON document_vectors
USING GIN (metadata jsonb_path_ops);
```

#### 2. ã‚¯ã‚¨ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥
```python
# LangChain Semantic Cacheï¼ˆPhase 3ã§å®Ÿè£…äºˆå®šï¼‰
from langchain.cache import RedisSemanticCache

# é¡ä¼¼è³ªå•ã®çµæœã‚’å†åˆ©ç”¨
# "æ˜¨æ—¥ã®ã‚¯ãƒ¬ãƒ¼ãƒ " â‰ˆ "å‰æ—¥ã®ã‚¯ãƒ¬ãƒ¼ãƒ " â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ
```

#### 3. ãƒãƒƒãƒå‡¦ç†
```python
# è¤‡æ•°ã‚¯ã‚¨ãƒªã®ä¸¦åˆ—ãƒ™ã‚¯ãƒˆãƒ«åŒ–ï¼ˆQuery Expansionæ™‚ï¼‰
embeddings = EmbeddingService.generate_embeddings_batch([
    "2025-12-09 å•é¡Œ",
    "12/9 ãƒˆãƒ©ãƒ–ãƒ«",
    "å‰æ—¥ ã‚¯ãƒ¬ãƒ¼ãƒ "
])
```

---

## æŠ€è¡“çš„ãªå·¥å¤«

### 1. SQLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã«ã‚ˆã‚‹SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³é˜²æ­¢

```python
# âŒ æ‚ªã„ä¾‹ï¼ˆSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§ï¼‰
sql = f"WHERE metadata->>'date' = '{date}'"

# âœ… è‰¯ã„ä¾‹ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ï¼‰
sql = "WHERE metadata->>'date' = %s"
params = [date]
cursor.execute(sql, params)
```

### 2. å‹•çš„WHEREå¥æ§‹ç¯‰

```python
where_clauses = []
params = [query_embedding]

if hasattr(user, 'store'):
    where_clauses.append("metadata->>'store_id' = %s")
    params.append(str(user.store.store_id))

if filters:
    # å‹•çš„ã«ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
    ...

where_clause = " AND ".join(where_clauses) if where_clauses else "1=1"
```

### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```python
try:
    # ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢å®Ÿè¡Œ
    ...
except Exception as e:
    logger.error(f"Error in vector search: {e}")
    return []  # ç©ºãƒªã‚¹ãƒˆã‚’è¿”ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¶™ç¶š
```

---

## ä½¿ç”¨ä¾‹

### åŸºæœ¬çš„ãªæ¤œç´¢

```python
from ai_features.services import VectorSearchService, QueryClassifier

# ã‚¯ã‚¨ãƒªã®æ›–æ˜§æ€§åˆ¤å®š
query = "æ˜¨æ—¥ã®å•é¡Œ"
is_ambiguous = QueryClassifier.is_ambiguous(query)  # True

# å‹•çš„Top-Kæ±ºå®š
top_k = QueryClassifier.classify_and_get_top_k(query)  # 5

# å®Ÿç¸¾æ¤œç´¢
results = VectorSearchService.search_documents(
    query=query,
    user=request.user,
    top_k=top_k
)

for result in results:
    print(f"é¡ä¼¼åº¦: {result['similarity']:.2f}")
    print(f"å†…å®¹: {result['content'][:100]}...")
```

### ãƒ•ã‚£ãƒ«ã‚¿ä»˜ãæ¤œç´¢

```python
# ç‰¹å®šæ—¥ä»˜ã®ã‚¯ãƒ¬ãƒ¼ãƒ ã®ã¿æ¤œç´¢
results = VectorSearchService.search_documents(
    query="æ–™ç†æä¾›é…å»¶",
    user=request.user,
    source_types=['daily_report'],
    filters={
        'date': '2025-12-09',
        'genre': 'claim'
    },
    top_k=3
)
```

### ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ¤œç´¢

```python
# ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼ç‚¹æ¤œæ‰‹é †ã‚’æ¤œç´¢
results = VectorSearchService.search_knowledge(
    query="ãƒ•ãƒ©ã‚¤ãƒ¤ãƒ¼ ç‚¹æ¤œ æ‰‹é †",
    category='cooking',
    document_type='manual',
    top_k=3
)

for result in results:
    print(f"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: {result['metadata']['document_title']}")
    print(f"ç« : {result['metadata'].get('chapter', 'N/A')}")
    print(f"é¡ä¼¼åº¦: {result['similarity']:.2f}")
```

---

## Phase 2 é€²æ—çŠ¶æ³

### âœ… å®Œäº†ï¼ˆ30%ï¼‰

1. **VectorSearchService**
   - `search_documents()`: å®Ÿç¸¾RAGæ¤œç´¢
   - `search_knowledge()`: ãƒŠãƒ¬ãƒƒã‚¸RAGæ¤œç´¢
   - ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
   - å‹•çš„Top-K

2. **QueryClassifier**
   - `classify_and_get_top_k()`: ã‚¯ã‚¨ãƒªæ€§è³ªåˆ†æ
   - `is_ambiguous()`: æ›–æ˜§æ€§åˆ¤å®š

### ğŸš§ æ¬¡å›å®Ÿè£…ï¼ˆæ®‹ã‚Š70%ï¼‰

1. **Query Expansionæ©Ÿèƒ½**
   - `QueryExpander`: LLMãƒ™ãƒ¼ã‚¹ã®ã‚¯ã‚¨ãƒªæ‹¡å¼µï¼ˆ3-5å€‹ï¼‰
   - æ—¥ä»˜æ­£è¦åŒ–ï¼ˆ"æ˜¨æ—¥" â†’ "2025-12-09"ï¼‰
   - åŒç¾©èªç”Ÿæˆï¼ˆ"å•é¡Œ" â†’ ["ãƒˆãƒ©ãƒ–ãƒ«", "ã‚¯ãƒ¬ãƒ¼ãƒ ", "äº‹æ•…"]ï¼‰

2. **Result Merger**
   - `ResultMerger`: æ¤œç´¢çµæœçµ±åˆãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°
   - é‡è¤‡æ’é™¤ï¼ˆsource_type + source_idï¼‰
   - ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°: `hit_count * 10 + max_similarity`

3. **æ¤œç´¢ãƒ„ãƒ¼ãƒ«3å€‹** (ai_features/tools/search_tools.py)
   - `search_past_cases()`: ç›´æ¥æ¤œç´¢ãƒ„ãƒ¼ãƒ«
   - `expand_and_search_cases()`: æ‹¡å¼µæ¤œç´¢ãƒ„ãƒ¼ãƒ«
   - `search_manual()`: ãƒãƒ‹ãƒ¥ã‚¢ãƒ«æ¤œç´¢ãƒ„ãƒ¼ãƒ«

4. **çµ±è¨ˆãƒ„ãƒ¼ãƒ«4å€‹** (ai_features/tools/analytics_tools.py)
   - `get_claim_statistics()`: ã‚¯ãƒ¬ãƒ¼ãƒ çµ±è¨ˆ
   - `get_sales_trend()`: å£²ä¸Šæ¨ç§»
   - `get_cash_difference_analysis()`: é•ç®—åˆ†æ
   - `compare_periods()`: æœŸé–“æ¯”è¼ƒ

---

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆï¼ˆæ›´æ–°ï¼‰

```
c3_app/
â”œâ”€â”€ ai_features/
â”‚   â”œâ”€â”€ models.py                           # (Act 01)
â”‚   â”œâ”€â”€ services.py                         # âœ… æ›´æ–°: 3ã‚¯ãƒ©ã‚¹è¿½åŠ 
â”‚   â”‚   â”œâ”€â”€ EmbeddingService                # (Act 01)
â”‚   â”‚   â”œâ”€â”€ VectorizationService            # (Act 01)
â”‚   â”‚   â”œâ”€â”€ VectorSearchService             # âœ… æ–°è¦
â”‚   â”‚   â””â”€â”€ QueryClassifier                 # âœ… æ–°è¦
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ document_parser.py              # (Act 01)
â”‚   â”‚   â””â”€â”€ knowledge_chunker.py            # (Act 01)
â”‚   â”œâ”€â”€ tools/                              # ğŸš§ æ¬¡å›ä½œæˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ search_tools.py                 # ğŸš§ æ¬¡å›å®Ÿè£…
â”‚   â”‚   â””â”€â”€ analytics_tools.py              # ğŸš§ æ¬¡å›å®Ÿè£…
â”‚   â””â”€â”€ management/
â”‚       â””â”€â”€ commands/
â”‚           â””â”€â”€ vectorize_knowledge.py      # (Act 01)
â”œâ”€â”€ plan.md                                 # (Act 01)
â”œâ”€â”€ act01.md                                # (Act 01)
â””â”€â”€ act02.md                                # ğŸ“„ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

### æ¤œç´¢å‡¦ç†ã®å…¨ä½“åƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   User Query                         â”‚
â”‚          "2025å¹´12æœˆ9æ—¥ã®ã‚¯ãƒ¬ãƒ¼ãƒ "                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              QueryClassifier                         â”‚
â”‚  â”œâ”€ is_ambiguous() â†’ Falseï¼ˆæ˜ç¢ºï¼‰                  â”‚
â”‚  â””â”€ classify_and_get_top_k() â†’ 3ï¼ˆç‰¹å®šäº‹ä¾‹ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            EmbeddingService                          â”‚
â”‚  generate_embedding("2025å¹´12æœˆ9æ—¥ã®ã‚¯ãƒ¬ãƒ¼ãƒ ")      â”‚
â”‚  â†’ [0.234, 0.456, ..., 0.789]  # 384æ¬¡å…ƒ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          VectorSearchService                         â”‚
â”‚  search_documents(                                   â”‚
â”‚    query="2025å¹´12æœˆ9æ—¥ã®ã‚¯ãƒ¬ãƒ¼ãƒ ",                 â”‚
â”‚    user=current_user,                                â”‚
â”‚    filters={'date': '2025-12-09', 'genre': 'claim'},â”‚
â”‚    top_k=3                                           â”‚
â”‚  )                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PostgreSQL + PgVector                   â”‚
â”‚  SELECT vector_id, content, metadata,                â”‚
â”‚         1 - (embedding <=> query_vec) AS similarity  â”‚
â”‚  FROM document_vectors                               â”‚
â”‚  WHERE metadata->>'store_id' = '1'                   â”‚
â”‚    AND metadata->>'date' = '2025-12-09'              â”‚
â”‚    AND metadata->>'genre' = 'claim'                  â”‚
â”‚  ORDER BY embedding <=> query_vec                    â”‚
â”‚  LIMIT 3                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ¤œç´¢çµæœ                              â”‚
â”‚  [                                                   â”‚
â”‚    {similarity: 0.92, content: "12æœˆ9æ—¥ãƒ›ãƒ¼ãƒ«..."},  â”‚
â”‚    {similarity: 0.87, content: "9æ—¥å¤•æ–¹..."},       â”‚
â”‚    {similarity: 0.82, content: "12/9ã‚­ãƒƒãƒãƒ³..."}   â”‚
â”‚  ]                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— (Act 03äºˆå®š)

### 1. Query Expansionæ©Ÿèƒ½
```python
# ai_features/services/query_expander.py
class QueryExpander:
    @classmethod
    def expand(query: str, user_context: dict) -> List[str]:
        """
        LLMã§ã‚¯ã‚¨ãƒªã‚’3-5å€‹ã«æ‹¡å¼µ

        å…¥åŠ›: "æ˜¨æ—¥ã®å•é¡Œ"
        å‡ºåŠ›: [
            "2025-12-09 å•é¡Œ",
            "12/9 ãƒˆãƒ©ãƒ–ãƒ«",
            "å‰æ—¥ ã‚¯ãƒ¬ãƒ¼ãƒ ",
            "æ˜¨æ—¥ äº‹æ•…",
            "2025å¹´12æœˆ9æ—¥ ä¸å…·åˆ"
        ]
        """
```

### 2. Result Mergeræ©Ÿèƒ½
```python
# ai_features/services/result_merger.py
class ResultMerger:
    @classmethod
    def merge_and_rank(results: List[List[Dict]]) -> List[Dict]:
        """
        è¤‡æ•°æ¤œç´¢çµæœã‚’çµ±åˆãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°

        - é‡è¤‡æ’é™¤: (source_type, source_id)
        - ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°: hit_count * 10 + max_similarity
        - ã‚½ãƒ¼ãƒˆ: final_scoreã®é™é †
        """
```

### 3. æ¤œç´¢ãƒ„ãƒ¼ãƒ«3å€‹ + çµ±è¨ˆãƒ„ãƒ¼ãƒ«4å€‹

**åˆè¨ˆ7å€‹ã®ãƒ„ãƒ¼ãƒ«**ã‚’LangChain Functionã¨ã—ã¦å®Ÿè£…ã€‚

---

## ã¾ã¨ã‚

Act 02ã§ã¯ã€**ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã®åŸºç›¤**ã‚’å®Œæˆã•ã›ã¾ã—ãŸã€‚

**é”æˆã—ãŸã“ã¨**:
- âœ… VectorSearchServiceï¼ˆå®Ÿç¸¾RAG + ãƒŠãƒ¬ãƒƒã‚¸RAGï¼‰
- âœ… QueryClassifierï¼ˆå‹•çš„Top-K + æ›–æ˜§æ€§åˆ¤å®šï¼‰
- âœ… PgVectorã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦æ¤œç´¢
- âœ… æŸ”è»Ÿãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

ã“ã‚Œã§ã€ã‚¯ã‚¨ãƒªã‹ã‚‰ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã¾ã§ ã®å®Œå…¨ãªãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå®Œæˆã—ã¾ã—ãŸã€‚æ¬¡ã®Act 03ã§ã¯ã€Query Expansionã€Result Mergerã€ãã—ã¦7ã¤ã®ãƒ„ãƒ¼ãƒ«ã‚’å®Ÿè£…ã—ã¦Phase 2ã‚’å®Œæˆã•ã›ã¾ã™ã€‚

---

**å®Ÿè£…è€…ãƒãƒ¼ãƒˆ**:
VectorSearchServiceã®å®Ÿè£…ã¯é †èª¿ã€‚SQLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã¨ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ã®æŸ”è»Ÿæ€§ãŒé‡è¦ã€‚æ¬¡å›ã®Query Expansionã§ã¯ã€Gemini 1.5 Flashã‚’ä½¿ç”¨ã—ã¦ã‚¯ã‚¨ãƒªã‚’æ‹¡å¼µã™ã‚‹äºˆå®šã€‚
