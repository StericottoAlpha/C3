{# ====== Bottom Nav + Other Drawer（一覧画面用：模様なし・統一トーン）====== #}

<nav class="fixed bottom-0 left-0 w-full z-50 border-t border-gray-200 bg-white/95 backdrop-blur supports-[backdrop-filter]:bg-white/75">
  <div class="mx-auto max-w-2xl">
    <div class="flex justify-around items-center h-[calc(4rem+env(safe-area-inset-bottom))] pb-[env(safe-area-inset-bottom)] text-[11px]">

      {% with current=request.resolver_match.view_name %}
      
      <a href="{% url 'reports:list' %}"
         class="flex flex-col items-center gap-1
         {% if current == 'reports:list' %}
           text-primary
         {% else %}
           text-gray-400 hover:text-primary
         {% endif %}">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
          <path d="M16 4h-1.2A3 3 0 0 0 12 2a3 3 0 0 0-2.8 2H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm-4-1a1 1 0 0 1 1 1h-2a1 1 0 0 1 1-1z"/>
        </svg>
        <span>日報</span>
      </a>

      <a href="{% url 'analytics:dashboard' %}"
         class="flex flex-col items-center gap-1 transition
         {% if current == 'analytics:dashboard' %}
           text-primary
         {% else %}
           text-gray-400 hover:text-primary
         {% endif %}">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="3" y="10" width="4" height="10" rx="1"/>
          <rect x="10" y="6" width="4" height="14" rx="1"/>
          <rect x="17" y="3" width="4" height="17" rx="1"/>
        </svg>
        <span class="leading-none">分析</span>
      </a>

      <a href="{% url 'bbs:list' %}"
         class="flex flex-col items-center gap-1 transition
         {% if current == 'bbs:list' %}
           text-primary
         {% else %}
           text-gray-400 hover:text-primary
         {% endif %}">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 4h16v11H7l-3 3V4z"/>
        </svg>
        <span class="leading-none">掲示板</span>
      </a>

      <a href="{% url 'common:index' %}"
         class="flex flex-col items-center gap-1 transition
         {% if current == 'common:index' %}
           text-primary
         {% else %}
           text-gray-400 hover:text-primary
         {% endif %}">
        <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3z"/>
        </svg>
        <span class="leading-none">ホーム</span>
      </a>

      <a href="{% url 'ai_features:chat_page' %}"
         class="flex flex-col items-center gap-1 transition
         {% if current == 'ai_features:chat_page' %}
           text-primary
         {% else %}
           text-gray-400 hover:text-primary
         {% endif %}">
        <div class="w-6 h-6 rounded-full border-2 border-current flex items-center justify-center text-[10px] font-extrabold">
          AI
        </div>
        <span class="leading-none">AI</span>
      </a>

      <button id="otherMenuBtn" type="button"
        class="flex flex-col items-center gap-1 transition text-gray-400 hover:text-primary"
        aria-controls="otherDrawer"
        aria-expanded="false">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="3" y="5" width="18" height="2"/>
          <rect x="3" y="11" width="18" height="2"/>
          <rect x="3" y="17" width="18" height="2"/>
        </svg>
        <span class="leading-none">その他</span>
      </button>

      {% endwith %}

    </div>
  </div>
</nav>

<div id="otherDrawerBackdrop"
     class="fixed inset-0 z-40 bg-black/30 hidden"></div>

<div id="otherDrawer"
     class="fixed inset-x-0 bottom-0 z-50 translate-y-full transition-transform duration-200 pointer-events-none"
     role="dialog" aria-modal="true" aria-hidden="true">
  <div class="mx-auto max-w-2xl">
    <div class="bg-white rounded-t-3xl shadow-2xl border border-gray-100">
      <div class="pt-3 pb-2">
        <div class="flex justify-center">
          <div class="h-1 w-24 bg-gray-200 rounded-full"></div>
        </div>

        <div class="mt-3 px-6 flex items-center justify-between">
          <p class="text-base font-extrabold text-gray-900">メニュー</p>
          <button type="button" id="otherDrawerCloseBtn"
                  class="rounded-xl p-2 text-gray-500 hover:bg-gray-100 hover:text-gray-700 transition"
                  aria-label="閉じる">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M18.3 5.7a1 1 0 0 0-1.4 0L12 10.6 7.1 5.7a1 1 0 1 0-1.4 1.4l4.9 4.9-4.9 4.9a1 1 0 1 0 1.4 1.4l4.9-4.9 4.9 4.9a1 1 0 0 0 1.4-1.4L13.4 12l4.9-4.9a1 1 0 0 0 0-1.4z"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="px-6 pb-[calc(env(safe-area-inset-bottom)+6.5rem)]">
        <div class="h-px bg-gray-200 my-4"></div>

        <div class="grid grid-cols-3 gap-x-6 gap-y-8 justify-items-center">

          <a href="/accounts/profile" data-drawer-close="1"
             class="group flex flex-col items-center gap-2.5">
            <div class="w-20 h-20 rounded-2xl bg-white border border-gray-200 shadow-sm
                        group-hover:shadow-md group-hover:border-teal-200 transition
                        flex items-center justify-center">
              <svg class="w-9 h-9 text-gray-600 group-hover:text-teal-600 transition"
                   viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-4.4 0-8 2-8 4.5V21h16v-2.5C20 16 16.4 14 12 14z"/>
              </svg>
            </div>
            <span class="text-sm font-semibold text-gray-700">ユーザー情報</span>
          </a>

          {% if user.user_type == 'admin' or user.user_type == 'manager' or user.is_superuser %}
            <a href="/accounts/signup" data-drawer-close="1"
               class="group flex flex-col items-center gap-2.5">
              <div class="w-20 h-20 rounded-2xl bg-white border border-gray-200 shadow-sm
                          group-hover:shadow-md group-hover:border-teal-200 transition
                          flex items-center justify-center">
                <svg class="w-9 h-9 text-gray-600 group-hover:text-teal-600 transition"
                     viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
              </div>
              <span class="text-sm font-semibold text-gray-700">ユーザー登録</span>
            </a>
          {% else %}
            <button type="button" disabled
              class="flex flex-col items-center gap-2.5 opacity-60 cursor-not-allowed">
              <div class="w-20 h-20 rounded-2xl bg-gray-50 border border-gray-200 flex items-center justify-center">
                <svg class="w-9 h-9 text-gray-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4z"/>
                </svg>
              </div>
              <span class="text-sm font-semibold text-gray-400">準備中</span>
            </button>
          {% endif %}

          {% if user.user_type == 'manager' or user.user_type == 'admin' %}
            <a href="{% url 'accounts:staff_list' %}" data-drawer-close="1"
               class="group flex flex-col items-center gap-2.5">
              <div class="w-20 h-20 rounded-2xl bg-white border border-gray-200 shadow-sm
                          group-hover:shadow-md group-hover:border-teal-200 transition
                          flex items-center justify-center">
                <svg class="w-9 h-9 text-gray-600 group-hover:text-teal-600 transition"
                     fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                </svg>
              </div>
              <span class="text-sm font-semibold text-gray-700">スタッフ編集</span>
            </a>
          {% else %}
            <button type="button" disabled
              class="flex flex-col items-center gap-2.5 opacity-60 cursor-not-allowed">
              <div class="w-20 h-20 rounded-2xl bg-gray-50 border border-gray-200 flex items-center justify-center">
                <svg class="w-9 h-9 text-gray-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M12 2a10 10 0 100 20 10 10 0 000-20zM8 12h8v2H8v-2z"/>
                </svg>
              </div>
              <span class="text-sm font-semibold text-gray-400">準備中</span>
            </button>
          {% endif %}

          {% if user.user_type == 'manager' %}
            <a href="{% url 'stores:update_goal' %}" data-drawer-close="1"
               class="group flex flex-col items-center gap-2.5">
              <div class="w-20 h-20 rounded-2xl bg-white border border-gray-200 shadow-sm
                          group-hover:shadow-md group-hover:border-teal-200 transition
                          flex items-center justify-center">
                <svg class="w-9 h-9 text-gray-600 group-hover:text-teal-600 transition" 
                     fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                     <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z" clip-rule="evenodd" />
                </svg>
              </div>
              <span class="text-sm font-semibold text-gray-700">店舗目標</span>
            </a>
          {% else %}
            <button type="button" disabled
              class="flex flex-col items-center gap-2.5 opacity-60 cursor-not-allowed">
              <div class="w-20 h-20 rounded-2xl bg-gray-50 border border-gray-200 flex items-center justify-center">
                <svg class="w-9 h-9 text-gray-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 14h-2v-2h2v2zm0-4h-2V6h2v6z"/>
                </svg>
              </div>
              <span class="text-sm font-semibold text-gray-400">準備中</span>
            </button>
          {% endif %}
          <button type="button" disabled
            class="flex flex-col items-center gap-2.5 opacity-60 cursor-not-allowed">
            <div class="w-20 h-20 rounded-2xl bg-gray-50 border border-gray-200 flex items-center justify-center">
              <svg class="w-9 h-9 text-gray-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M12 7a5 5 0 015 5c0 1.7-.8 3.2-2 4.1V18a3 3 0 01-6 0v-1.9A5 5 0 017 12a5 5 0 015-5zm-1 13h2v-2h-2v2z"/>
              </svg>
            </div>
            <span class="text-sm font-semibold text-gray-400">準備中</span>
          </button>

          <button type="button" disabled
            class="flex flex-col items-center gap-2.5 opacity-60 cursor-not-allowed">
            <div class="w-20 h-20 rounded-2xl bg-gray-50 border border-gray-200 flex items-center justify-center">
              <svg class="w-9 h-9 text-gray-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M12 2a10 10 0 100 20 10 10 0 000-20zm1 14h-2v-2h2v2zm0-4h-2V6h2v6z"/>
              </svg>
            </div>
            <span class="text-sm font-semibold text-gray-400">準備中</span>
          </button>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const btn = document.getElementById("otherMenuBtn");
    const drawer = document.getElementById("otherDrawer");
    const backdrop = document.getElementById("otherDrawerBackdrop");
    const closeBtn = document.getElementById("otherDrawerCloseBtn");

    if (!btn || !drawer || !backdrop) return;

    let opened = false;

    function setBtnActive(active) {
      if (active) {
        btn.classList.remove("text-gray-400");
        btn.classList.add("text-primary");
        btn.setAttribute("aria-expanded", "true");
      } else {
        btn.classList.add("text-gray-400");
        btn.classList.remove("text-primary");
        btn.setAttribute("aria-expanded", "false");
      }
    }

    function openDrawer() {
      if (opened) return;
      opened = true;

      backdrop.classList.remove("hidden");
      drawer.classList.remove("translate-y-full");
      drawer.classList.remove("pointer-events-none");
      drawer.setAttribute("aria-hidden", "false");

      document.documentElement.classList.add("overflow-hidden");
      setBtnActive(true);
    }

    function closeDrawer() {
      if (!opened) return;
      opened = false;

      drawer.classList.add("translate-y-full");
      drawer.setAttribute("aria-hidden", "true");
      drawer.classList.add("pointer-events-none");

      setTimeout(() => {
        if (!opened) backdrop.classList.add("hidden");
      }, 200);

      document.documentElement.classList.remove("overflow-hidden");
      setBtnActive(false);
    }

    btn.addEventListener("click", () => (opened ? closeDrawer() : openDrawer()));
    backdrop.addEventListener("click", closeDrawer);
    if (closeBtn) closeBtn.addEventListener("click", closeDrawer);

    drawer.addEventListener("click", (e) => {
      const el = e.target.closest("[data-drawer-close='1']");
      if (el) closeDrawer();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeDrawer();
    });
  })();
</script>