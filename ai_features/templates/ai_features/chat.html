{% extends "base.html" %}

{% block content %}
<div class="flex justify-center items-center min-h-screen bg-gray-100">

  <!-- チャット全体 -->
  <div class="flex flex-col w-full max-w-3xl h-[80vh] bg-white border rounded-lg">

    <!-- ヘッダー -->
    <div class="flex items-center justify-between px-4 py-3 border-b bg-white">
      <h2 class="text-lg font-semibold text-gray-800">AIチャット</h2>
      <button
        id="clear-history-button"
        onclick="confirmClearHistory()"
        class="flex items-center gap-1 px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded-lg transition"
        title="会話履歴を削除"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
        </svg>
        <span>履歴削除</span>
      </button>
    </div>

    <!-- メッセージ表示エリア -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-100"></div>

    <!-- 入力欄（下固定） -->
    <div class="border-t p-3 flex items-center gap-2 bg-white">
      <div
        id="chat-error"
        class="hidden text-sm text-red-600 px-4 py-2 bg-red-50 border-t"
      ></div>
      <input
        id="chat-input"
        type="text"
        placeholder="メッセージを入力"
        class="flex-1 border rounded-full px-4 py-2 focus:outline-none"
        disabled
      />
      <button
        id="send-button"
        type="submit"
        onClick="postHandler()"
        class="bg-green-500 text-white px-4 py-2 rounded-full opacity-50 cursor-not-allowed"
        disabled
      >
        送信
      </button>
    </div>

  </div>
</div>



{% endblock %}

{% block extra_head %}
<!-- Highlight.js for syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
  /* Markdown (prose) スタイル */
  .markdown-content {
    color: #374151;
    line-height: 1.75;
  }
  .markdown-content > * + * {
    margin-top: 1em;
  }
  .markdown-content p {
    margin-top: 0.75em;
    margin-bottom: 0.75em;
  }
  .markdown-content h1 {
    font-size: 1.5em;
    font-weight: 700;
    margin-top: 1em;
    margin-bottom: 0.5em;
    line-height: 1.25;
  }
  .markdown-content h2 {
    font-size: 1.25em;
    font-weight: 600;
    margin-top: 1em;
    margin-bottom: 0.5em;
    line-height: 1.3;
  }
  .markdown-content h3 {
    font-size: 1.125em;
    font-weight: 600;
    margin-top: 0.75em;
    margin-bottom: 0.5em;
    line-height: 1.4;
  }
  .markdown-content ul, .markdown-content ol {
    padding-left: 1.5em;
    margin-top: 0.75em;
    margin-bottom: 0.75em;
  }
  .markdown-content ul {
    list-style-type: disc;
  }
  .markdown-content ol {
    list-style-type: decimal;
  }
  .markdown-content li {
    margin-top: 0.25em;
    margin-bottom: 0.25em;
  }
  .markdown-content ul > li > ul,
  .markdown-content ol > li > ol {
    margin-top: 0.25em;
    margin-bottom: 0.25em;
  }
  .markdown-content code {
    background-color: #f3f4f6;
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }
  .markdown-content pre {
    background-color: #f6f8fa;
    border-radius: 0.5rem;
    padding: 1em;
    overflow-x: auto;
    margin-top: 1em;
    margin-bottom: 1em;
  }
  .markdown-content pre code {
    background-color: transparent;
    padding: 0;
    font-size: 0.875em;
    line-height: 1.5;
  }
  .markdown-content blockquote {
    border-left: 4px solid #e5e7eb;
    padding-left: 1em;
    margin-left: 0;
    font-style: italic;
    color: #6b7280;
  }
  .markdown-content a {
    color: #2563eb;
    text-decoration: underline;
  }
  .markdown-content a:hover {
    color: #1d4ed8;
  }
  .markdown-content strong {
    font-weight: 600;
  }
  .markdown-content em {
    font-style: italic;
  }
  .markdown-content hr {
    border: 0;
    border-top: 1px solid #e5e7eb;
    margin-top: 1.5em;
    margin-bottom: 1.5em;
  }
  .markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1em;
    margin-bottom: 1em;
  }
  .markdown-content th, .markdown-content td {
    border: 1px solid #e5e7eb;
    padding: 0.5em;
    text-align: left;
  }
  .markdown-content th {
    background-color: #f9fafb;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block extra_js %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- DOMPurify for XSS protection -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<!-- Highlight.js for syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
// Marked.js設定
marked.setOptions({
  breaks: true,
  gfm: true,
  headerIds: false,
  mangle: false
});

// CSRFトークンを取得
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('DOMContentLoaded', () => {
  setupInputHandler();
  loadChatHistory();
});

function loadChatHistory() {
  fetch('/ai/api/chat/')
    .then(res => res.json())
    .then(data => {
      if (data.history && data.history.length > 0) {
        // 履歴がある場合は表示
        data.history.forEach(item => {
          appendMessage(item.content, item.role);
        });
      } else {
        // 履歴が空の場合は空メッセージを表示
        showEmptyHistoryMessage();
      }
    })
    .catch(() => {
      appendMessage('エラーが発生しました。しばらくしてから再度お試しください。', 'assistant');
    });
}

function showEmptyHistoryMessage() {
  const container = document.getElementById('chat-container');
  const emptyMessage = document.createElement('div');
  emptyMessage.id = 'empty-history-message';
  emptyMessage.className = 'flex flex-col items-center justify-center h-full text-gray-400';
  emptyMessage.innerHTML = `
    <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
    </svg>
    <p class="text-lg font-medium">会話履歴がありません</p>
    <p class="text-sm mt-2">メッセージを送信して会話を始めましょう</p>
  `;
  container.appendChild(emptyMessage);
}

function removeEmptyHistoryMessage() {
  const emptyMessage = document.getElementById('empty-history-message');
  if (emptyMessage) {
    emptyMessage.remove();
  }
}

function appendMessage(text, sender) {
  const wrapper = document.createElement('div');
  wrapper.className =
    sender === 'user'
      ? 'flex justify-end'
      : 'flex justify-start';

  const bubble = document.createElement('div');
  bubble.className =
    sender === 'user'
      ? 'bg-green-500 text-white px-4 py-2 rounded-2xl max-w-xl break-words'
      : 'bg-white px-4 py-2 rounded-2xl max-w-xl border markdown-content';

  // AIメッセージの場合はマークダウンをレンダリング
  if (sender === 'assistant') {
    const rawHtml = marked.parse(text);
    const cleanHtml = DOMPurify.sanitize(rawHtml);
    bubble.innerHTML = cleanHtml;

    // コードブロックにシンタックスハイライトを適用
    bubble.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightElement(block);
    });
  } else {
    bubble.innerText = text;
  }

  wrapper.appendChild(bubble);
  document.getElementById('chat-container').appendChild(wrapper);

  // スクロールを最下部に
  const container = document.getElementById('chat-container');
  container.scrollTop = container.scrollHeight;
}

function setupInputHandler() {
  const input = document.getElementById('chat-input');
  const button = document.getElementById('send-button');

  // 将来有効化する前提で disabled を外す
  input.disabled = false;

  input.addEventListener('input', () => {
    const hasText = input.value.trim().length > 0;

    button.disabled = !hasText;

    if (hasText) {
      button.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      button.classList.add('opacity-50', 'cursor-not-allowed');
    }
  });
}

function postHandler(){

  clearChatError();
  const input = document.getElementById("chat-input");
  const button = document.getElementById("send-button");

  const message = input.value.trim();

  if (!message){
    
    input.value = "";
    return;
  }

  input.value = "";
  button.disabled = true;
  button.classList.add('opacity-50', 'cursor-not-allowed');

  // 空メッセージを削除（最初のメッセージの場合）
  removeEmptyHistoryMessage();

  appendMessage(message, "user");

  const loadingId = appendLoadingMessage();

  fetch('/ai/api/chat/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      message: message,
      include_history: true
    })
  })
  .then(res => res.json())
  .then(data => {
    removeLoadingMessage(loadingId);
    appendMessage(data.message, 'assistant');
  })
  .catch(() => {
    removeLoadingMessage(loadingId);
    appendMessage('エラーが発生しました。しばらくしてから再度お試しください。', 'assistant');
  })
}

function clearChatError() {
  const errorEl = document.getElementById('chat-error');
  errorEl.innerText = '';
  errorEl.classList.add('hidden');
}

function appendLoadingMessage() {
  const id = 'loading-' + Date.now();
  const wrapper = document.createElement('div');
  wrapper.id = id;
  wrapper.className = 'flex justify-start';

  const bubble = document.createElement('div');
  bubble.className = 'bg-white px-4 py-2 rounded-2xl max-w-xs border text-gray-400';
  bubble.innerText = '入力中…';

  wrapper.appendChild(bubble);
  document.getElementById('chat-container').appendChild(wrapper);

  return id;
}

function removeLoadingMessage(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

function confirmClearHistory() {
  if (confirm('会話履歴を削除しますか？\nこの操作は取り消せません。')) {
    clearChatHistory();
  }
}

function clearChatHistory() {
  const button = document.getElementById('clear-history-button');
  button.disabled = true;
  button.classList.add('opacity-50', 'cursor-not-allowed');

  fetch('/ai/api/chat/history/clear/', {
    method: 'DELETE',
    headers: {
      'X-CSRFToken': getCookie('csrftoken')
    }
  })
  .then(res => res.json())
  .then(data => {
    // 成功: 画面をクリアして空メッセージを表示
    const container = document.getElementById('chat-container');
    container.innerHTML = '';
    showEmptyHistoryMessage();

    button.disabled = false;
    button.classList.remove('opacity-50', 'cursor-not-allowed');
  })
  .catch(error => {
    console.error('Error clearing history:', error);
    alert('履歴の削除に失敗しました。');

    button.disabled = false;
    button.classList.remove('opacity-50', 'cursor-not-allowed');
  });
}
</script>
{% endblock %}