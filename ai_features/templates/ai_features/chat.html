{% extends "base.html" %}

{% block title %}AIチャット - GenbaNote{% endblock %}

{% block content %}
<div class="h-screen bg-[#b9cfcc] relative overflow-hidden">

  <!-- 背景：控えめ（紙感＋薄いグラデ） -->
  <div class="absolute inset-0 pointer-events-none">
    <div class="absolute inset-0 bg-gradient-to-b from-white/10 via-transparent to-black/5"></div>
    <div class="absolute inset-0 opacity-[0.045]"
         style="background-image: radial-gradient(rgba(0,0,0,.35) 0.6px, transparent 0.6px);
                background-size: 14px 14px;"></div>
  </div>

  <!-- 装飾：少なめ（角に薄い波紋1〜2個だけ） -->
  <div class="absolute inset-0 pointer-events-none z-0">
    <div class="absolute left-6 top-16 w-28 h-28 rounded-full border border-white/18"></div>
    <div class="absolute right-8 bottom-28 w-36 h-36 rounded-full border border-white/12"></div>
  </div>

  <div class="relative z-10 max-w-3xl mx-auto px-4 pt-8">

    <!-- ヘッダー -->
    <div class="flex items-start justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold text-[#2f2f2f] tracking-wide">AIチャット</h1>
        <p class="mt-1 text-sm text-white/90">AIアシスタントに質問できます</p>
      </div>

      <button
        id="clear-history-button"
        onclick="confirmClearHistory()"
        class="shrink-0 inline-flex items-center gap-2 px-4 py-2 rounded-xl
               bg-white/70 border border-white/70 text-rose-600 font-bold text-sm shadow
               hover:bg-rose-50 transition"
        title="会話履歴を削除"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
        </svg>
        <span>履歴削除</span>
      </button>
    </div>

    <!-- チャットコンテナ -->
    <div class="bg-white/75 border border-white/70 rounded-2xl shadow-[0_14px_30px_rgba(0,0,0,0.12)] overflow-hidden">

      <!-- メッセージ表示エリア -->
      <div id="chat-container" class="h-[55vh] overflow-y-auto p-4 sm:p-5 space-y-3 bg-black/[0.02]"></div>

      <!-- 入力欄 -->
      <div class="border-t border-black/5 p-4 flex items-center gap-3 bg-white/50">
        <div
          id="chat-error"
          class="hidden text-sm text-rose-600 px-4 py-2 bg-rose-50 rounded-xl"
        ></div>
        <input
          id="chat-input"
          type="text"
          placeholder="メッセージを入力..."
          class="flex-1 rounded-xl border border-black/10 bg-white/70 px-4 py-3 text-sm
                 focus:outline-none focus:ring-2 focus:ring-black/10 text-[#2f2f2f] placeholder:text-[#2f2f2f]/35"
          disabled
        />
        <button
          id="send-button"
          type="submit"
          onClick="postHandler()"
          class="px-5 py-3 rounded-xl bg-primary text-white font-bold text-sm
                 shadow transition opacity-50 cursor-not-allowed"
          disabled
        >
          送信
        </button>
      </div>

    </div>

  </div>
</div>

{% endblock %}

{% block extra_head %}
<!-- Highlight.js for syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
<style>
  /* Markdown (prose) スタイル */
  .markdown-content {
    color: #2f2f2f;
    line-height: 1.75;
  }
  .markdown-content > * + * {
    margin-top: 1em;
  }
  .markdown-content p {
    margin-top: 0.75em;
    margin-bottom: 0.75em;
  }
  .markdown-content h1 {
    font-size: 1.5em;
    font-weight: 700;
    margin-top: 1em;
    margin-bottom: 0.5em;
    line-height: 1.25;
  }
  .markdown-content h2 {
    font-size: 1.25em;
    font-weight: 600;
    margin-top: 1em;
    margin-bottom: 0.5em;
    line-height: 1.3;
  }
  .markdown-content h3 {
    font-size: 1.125em;
    font-weight: 600;
    margin-top: 0.75em;
    margin-bottom: 0.5em;
    line-height: 1.4;
  }
  .markdown-content ul, .markdown-content ol {
    padding-left: 1.5em;
    margin-top: 0.75em;
    margin-bottom: 0.75em;
  }
  .markdown-content ul {
    list-style-type: disc;
  }
  .markdown-content ol {
    list-style-type: decimal;
  }
  .markdown-content li {
    margin-top: 0.25em;
    margin-bottom: 0.25em;
  }
  .markdown-content ul > li > ul,
  .markdown-content ol > li > ol {
    margin-top: 0.25em;
    margin-bottom: 0.25em;
  }
  .markdown-content code {
    background-color: rgba(0,0,0,0.05);
    padding: 0.2em 0.4em;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  }
  .markdown-content pre {
    background-color: rgba(0,0,0,0.03);
    border-radius: 0.75rem;
    padding: 1em;
    overflow-x: auto;
    margin-top: 1em;
    margin-bottom: 1em;
    border: 1px solid rgba(0,0,0,0.1);
  }
  .markdown-content pre code {
    background-color: transparent;
    padding: 0;
    font-size: 0.875em;
    line-height: 1.5;
  }
  .markdown-content blockquote {
    border-left: 4px solid rgba(0,0,0,0.1);
    padding-left: 1em;
    margin-left: 0;
    font-style: italic;
    color: rgba(47,47,47,0.7);
  }
  .markdown-content a {
    color: #0d9488;
    text-decoration: underline;
  }
  .markdown-content a:hover {
    color: #0f766e;
  }
  .markdown-content strong {
    font-weight: 600;
  }
  .markdown-content em {
    font-style: italic;
  }
  .markdown-content hr {
    border: 0;
    border-top: 1px solid rgba(0,0,0,0.1);
    margin-top: 1.5em;
    margin-bottom: 1.5em;
  }
  .markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1em;
    margin-bottom: 1em;
  }
  .markdown-content th, .markdown-content td {
    border: 1px solid rgba(0,0,0,0.1);
    padding: 0.5em;
    text-align: left;
  }
  .markdown-content th {
    background-color: rgba(0,0,0,0.03);
    font-weight: 600;
  }

  /* ユーザーメッセージバブル */
  .user-bubble {
    background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    border-bottom-right-radius: 0.25rem;
    max-width: 80%;
    word-break: break-word;
    box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
  }

  /* AIメッセージバブル */
  .ai-bubble {
    background: rgba(255,255,255,0.9);
    border: 1px solid rgba(255,255,255,0.7);
    padding: 0.75rem 1rem;
    border-radius: 1rem;
    border-bottom-left-radius: 0.25rem;
    max-width: 85%;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
</style>
{% endblock %}

{% block extra_js %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- DOMPurify for XSS protection -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<!-- Highlight.js for syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
// ストリーミングAPIのベースURL
const STREAM_API_URL = "{{ stream_api_url }}";

// Marked.js設定
marked.setOptions({
  breaks: true,
  gfm: true,
  headerIds: false,
  mangle: false
});

// CSRFトークンを取得
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

<!-- 初期ロード -->
document.addEventListener('DOMContentLoaded', () => {
  setupInputHandler();
  loadChatHistory();
});

function loadChatHistory() {
  fetch('/ai/api/chat/')
    .then(res => res.json())
    .then(data => {
      if (data.history && data.history.length > 0) {
        // 履歴がある場合は表示
        data.history.forEach(item => {
          appendMessage(item.content, item.role);
        });
      } else {
        // 履歴が空の場合は空メッセージを表示
        showEmptyHistoryMessage();
      }
    })
    .catch(() => {
      appendMessage('エラーが発生しました。しばらくしてから再度お試しください。', 'assistant');
    });
}

function showEmptyHistoryMessage() {
  const container = document.getElementById('chat-container');
  const emptyMessage = document.createElement('div');
  emptyMessage.id = 'empty-history-message';
  emptyMessage.className = 'flex flex-col items-center justify-center h-full text-[#2f2f2f]/50';
  emptyMessage.innerHTML = `
    <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
    </svg>
    <p class="text-lg font-bold text-[#2f2f2f]">会話履歴がありません</p>
    <p class="text-sm mt-2 text-[#2f2f2f]/60">メッセージを送信して会話を始めましょう</p>
  `;
  container.appendChild(emptyMessage);
}

function removeEmptyHistoryMessage() {
  const emptyMessage = document.getElementById('empty-history-message');
  if (emptyMessage) {
    emptyMessage.remove();
  }
}

function appendMessage(text, sender) {
  const wrapper = document.createElement('div');
  wrapper.className =
    sender === 'user'
      ? 'flex justify-end'
      : 'flex justify-start';

  const bubble = document.createElement('div');
  bubble.className =
    sender === 'user'
      ? 'user-bubble'
      : 'ai-bubble markdown-content';

  // AIメッセージの場合はマークダウンをレンダリング
  if (sender === 'assistant') {
    const rawHtml = marked.parse(text);
    const cleanHtml = DOMPurify.sanitize(rawHtml);
    bubble.innerHTML = cleanHtml;

    // コードブロックにシンタックスハイライトを適用
    bubble.querySelectorAll('pre code').forEach((block) => {
      hljs.highlightElement(block);
    });
  } else {
    bubble.innerText = text;
  }

  wrapper.appendChild(bubble);
  document.getElementById('chat-container').appendChild(wrapper);

  // スクロールを最下部に
  const container = document.getElementById('chat-container');
  container.scrollTop = container.scrollHeight;
}

function setupInputHandler() {
  const input = document.getElementById('chat-input');
  const button = document.getElementById('send-button');

  // 将来有効化する前提で disabled を外す
  input.disabled = false;

  input.addEventListener('input', () => {
    const hasText = input.value.trim().length > 0;

    button.disabled = !hasText;

    if (hasText) {
      button.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      button.classList.add('opacity-50', 'cursor-not-allowed');
    }
  });

  // Enterキーで送信
  input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !button.disabled) {
      postHandler();
    }
  });
}

function postHandler(){

  clearChatError();
  const input = document.getElementById("chat-input");
  const button = document.getElementById("send-button");

  const message = input.value.trim();

  if (!message){

    input.value = "";
    return;
  }

  input.value = "";
  button.disabled = true;
  button.classList.add('opacity-50', 'cursor-not-allowed');

  // 空メッセージを削除（最初のメッセージの場合）
  removeEmptyHistoryMessage();

  appendMessage(message, "user");

  // ストリーミングレスポンスを受信
  handleStreamingChat(message, button);
}

function handleStreamingChat(message, button) {
  // AI応答用のバブルを作成
  const responseId = 'streaming-' + Date.now();
  const wrapper = document.createElement('div');
  wrapper.id = responseId;
  wrapper.className = 'flex justify-start';

  const bubble = document.createElement('div');
  bubble.className = 'ai-bubble markdown-content';
  bubble.innerText = ''; // 空で開始

  wrapper.appendChild(bubble);
  document.getElementById('chat-container').appendChild(wrapper);

  let fullResponse = '';

  // ストリーミングAPIのURL（環境変数で設定されていれば別サーバー、なければ同じサーバー）
  const streamUrl = STREAM_API_URL ? `${STREAM_API_URL}/api/ai/chat/stream/` : '/ai/api/chat/stream/';

  fetch(streamUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    credentials: 'include',  // Cookie送信を有効化
    body: JSON.stringify({
      message: message,
      include_history: true
    })
  })
  .then(response => {
    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    function readStream() {
      reader.read().then(({ done, value }) => {
        if (done) {
          // ストリーミング完了 - マークダウンをレンダリング
          const rawHtml = marked.parse(fullResponse);
          const cleanHtml = DOMPurify.sanitize(rawHtml);
          bubble.innerHTML = cleanHtml;

          // コードブロックにシンタックスハイライトを適用
          bubble.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });

          button.disabled = false;
          button.classList.remove('opacity-50', 'cursor-not-allowed');
          return;
        }

        // SSE データをパース
        const chunk = decoder.decode(value, { stream: true });
        const lines = chunk.split('\n');

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const jsonStr = line.substring(6);
            try {
              const data = JSON.parse(jsonStr);

              if (data.type === 'content') {
                fullResponse += data.content;
                bubble.innerText = fullResponse; // リアルタイムで表示
              } else if (data.type === 'error') {
                bubble.innerText = 'エラー: ' + data.content;
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
                return;
              }
            } catch (e) {
              // JSONパースエラーは無視（不完全なチャンクの可能性）
            }
          }
        }

        // スクロールを最下部に
        const container = document.getElementById('chat-container');
        container.scrollTop = container.scrollHeight;

        // 次のチャンクを読む
        readStream();
      });
    }

    readStream();
  })
  .catch(error => {
    console.error('Streaming error:', error);
    const wrapper = document.getElementById(responseId);
    if (wrapper) {
      wrapper.remove();
    }
    appendMessage('エラーが発生しました。しばらくしてから再度お試しください。', 'assistant');
    button.disabled = false;
    button.classList.remove('opacity-50', 'cursor-not-allowed');
  });
}

function clearChatError() {
  const errorEl = document.getElementById('chat-error');
  errorEl.innerText = '';
  errorEl.classList.add('hidden');
}

function appendLoadingMessage() {
  const id = 'loading-' + Date.now();
  const wrapper = document.createElement('div');
  wrapper.id = id;
  wrapper.className = 'flex justify-start';

  const bubble = document.createElement('div');
  bubble.className = 'ai-bubble text-[#2f2f2f]/50';
  bubble.innerText = '入力中…';

  wrapper.appendChild(bubble);
  document.getElementById('chat-container').appendChild(wrapper);

  return id;
}

function removeLoadingMessage(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

function confirmClearHistory() {
  if (confirm('会話履歴を削除しますか？\nこの操作は取り消せません。')) {
    clearChatHistory();
  }
}

function clearChatHistory() {
  const button = document.getElementById('clear-history-button');
  button.disabled = true;
  button.classList.add('opacity-50', 'cursor-not-allowed');

  fetch('/ai/api/chat/history/clear/', {
    method: 'DELETE',
    headers: {
      'X-CSRFToken': getCookie('csrftoken')
    }
  })
  .then(res => res.json())
  .then(data => {
    // 成功: 画面をクリアして空メッセージを表示
    const container = document.getElementById('chat-container');
    container.innerHTML = '';
    showEmptyHistoryMessage();

    button.disabled = false;
    button.classList.remove('opacity-50', 'cursor-not-allowed');
  })
  .catch(error => {
    console.error('Error clearing history:', error);
    alert('履歴の削除に失敗しました。');

    button.disabled = false;
    button.classList.remove('opacity-50', 'cursor-not-allowed');
  });
}
</script>
{% endblock %}
