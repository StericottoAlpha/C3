{% extends "base.html" %}

{% block content %}
<div class="flex justify-center items-center min-h-screen bg-gray-100">

  <!-- チャット全体 -->
  <div class="flex flex-col w-full max-w-3xl h-[80vh] bg-white border rounded-lg">

    <!-- メッセージ表示エリア -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-100"></div>

    <!-- 入力欄（下固定） -->
    <div class="border-t p-3 flex items-center gap-2 bg-white">
      <div
        id="chat-error"
        class="hidden text-sm text-red-600 px-4 py-2 bg-red-50 border-t"
      ></div>
      <input
        id="chat-input"
        type="text"
        placeholder="メッセージを入力"
        class="flex-1 border rounded-full px-4 py-2 focus:outline-none"
        disabled
      />
      <button
        id="send-button"
        type="submit"
        onClick="postHandler()"
        class="bg-green-500 text-white px-4 py-2 rounded-full opacity-50 cursor-not-allowed"
        disabled
      >
        送信
      </button>
    </div>

  </div>
</div>



{% endblock %}

{% block extra_js %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- DOMPurify for XSS protection -->
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

<script>
// Marked.js設定
marked.setOptions({
  breaks: true,
  gfm: true,
  headerIds: false,
  mangle: false
});

// CSRFトークンを取得
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('DOMContentLoaded', () => {
  setupInputHandler();
  loadChatHistory();
});

function loadChatHistory() {
  fetch('/ai/api/chat/')
    .then(res => res.json())
    .then(data => {
      data.history.forEach(item => {

        appendMessage(item.content, item.role);
      });
    })
    .catch(() => {
      showChatError('エラーが発生しました。しばらくしてから再度お試しください。');
    });
}

function appendMessage(text, sender) {
  const wrapper = document.createElement('div');
  wrapper.className =
    sender === 'user'
      ? 'flex justify-end'
      : 'flex justify-start';

  const bubble = document.createElement('div');
  bubble.className =
    sender === 'user'
      ? 'bg-green-500 text-white px-4 py-2 rounded-2xl max-w-xl break-words'
      : 'bg-white px-4 py-2 rounded-2xl max-w-xl border prose prose-sm';

  // AIメッセージの場合はマークダウンをレンダリング
  if (sender === 'assistant') {
    const rawHtml = marked.parse(text);
    const cleanHtml = DOMPurify.sanitize(rawHtml);
    bubble.innerHTML = cleanHtml;
  } else {
    bubble.innerText = text;
  }

  wrapper.appendChild(bubble);
  document.getElementById('chat-container').appendChild(wrapper);

  // スクロールを最下部に
  const container = document.getElementById('chat-container');
  container.scrollTop = container.scrollHeight;
}

function setupInputHandler() {
  const input = document.getElementById('chat-input');
  const button = document.getElementById('send-button');

  // 将来有効化する前提で disabled を外す
  input.disabled = false;

  input.addEventListener('input', () => {
    const hasText = input.value.trim().length > 0;

    button.disabled = !hasText;

    if (hasText) {
      button.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      button.classList.add('opacity-50', 'cursor-not-allowed');
    }
  });
}

function postHandler(){

  clearChatError();
  const input = document.getElementById("chat-input");
  const button = document.getElementById("send-button");

  const message = input.value.trim();

  if (!message){
    
    input.value = "";
    return;
  }

  input.value = "";
  button.disabled = true;
  button.classList.add('opacity-50', 'cursor-not-allowed');

  appendMessage(message, "user");

  const loadingId = appendLoadingMessage();

  fetch('/ai/api/chat/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      message: message,
      include_history: true
    })
  })
  .then(res => res.json())
  .then(data => {
    removeLoadingMessage(loadingId);
    appendMessage(data.message, 'assistant');
  })
  .catch(() => {
    removeLoadingMessage(loadingId);
    showChatError('エラーが発生しました。しばらくしてから再度お試しください。');
  })
}

function showChatError(message) {
  const errorEl = document.getElementById('chat-error');
  errorEl.innerText = message;
  errorEl.classList.remove('hidden');
}

function clearChatError() {
  const errorEl = document.getElementById('chat-error');
  errorEl.innerText = '';
  errorEl.classList.add('hidden');
}

function appendLoadingMessage() {
  const id = 'loading-' + Date.now();
  const wrapper = document.createElement('div');
  wrapper.id = id;
  wrapper.className = 'flex justify-start';

  const bubble = document.createElement('div');
  bubble.className = 'bg-white px-4 py-2 rounded-2xl max-w-xs border text-gray-400';
  bubble.innerText = '入力中…';

  wrapper.appendChild(bubble);
  document.getElementById('chat-container').appendChild(wrapper);

  return id;
}

function removeLoadingMessage(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}
</script>
{% endblock %}