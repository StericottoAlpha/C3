# システムアーキテクチャ

## 概要

本プロダクトは、Django + HTMXをベースとしたモノリシックアーキテクチャに、AIチャット用のストリーミングサーバーを追加したハイブリッド構成を採用しています。

---

## システム構成図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              クライアント                               │
│                    （ブラウザ / PWA対応モバイル）                       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              Render                                     │
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐       │
│  │      c3-app (WSGI)          │  │   c3-app-stream (ASGI)      │       │
│  │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │       │
│  │  │  Gunicorn             │  │  │  │  Uvicorn              │  │       │
│  │  │  Django 5.2.4         │  │  │  │  FastAPI              │  │       │
│  │  │  ポート: $PORT        │  │  │  │  ポート: $PORT        │  │       │
│  │  └───────────────────────┘  │  │  └───────────────────────┘  │       │
│  │  - 通常のHTTPリクエスト     │  │  - AIチャットストリーミング │       │
│  │  - HTMX部分更新             │  │  - Server-Sent Events       │       │
│  │  - REST API                 │  │  - 長時間接続対応           │       │
│  └─────────────────────────────┘  └─────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
                    │                               │
                    └───────────────┬───────────────┘
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                                Supabase                                 │
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐       │
│  │     PostgreSQL 17           │  │    Supabase Storage         │       │
│  │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │       │
│  │  │  pgvector拡張         │  │  │  │  S3互換API            │  │       │
│  │  │  ベクトル検索対応     │  │  │  │  画像ストレージ       │  │       │
│  │  └───────────────────────┘  │  │  └───────────────────────┘  │       │
│  └─────────────────────────────┘  └─────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           OpenAI API                                    │
│                    GPT-4o-mini / Embeddings                             │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## コンポーネント詳細

### 1. メインWebサーバー (c3-app)

| 項目 | 内容 |
|------|------|
| **ランタイム** | Python 3.11.0 |
| **フレームワーク** | Django 5.2.4 |
| **サーバー** | Gunicorn (WSGI) |
| **タイムアウト** | 180秒 |
| **ワーカー数** | 1 |

**処理内容:**
- HTMLページのレンダリング
- HTMX部分更新レスポンス
- REST API（JSON）
- 認証・セッション管理
- 静的ファイル配信（WhiteNoise）

### 2. ストリーミングサーバー (c3-app-stream)

| 項目 | 内容 |
|------|------|
| **ランタイム** | Python 3.11.0 |
| **フレームワーク** | FastAPI |
| **サーバー** | Uvicorn (ASGI) |
| **Keep-Alive** | 300秒 |

**処理内容:**
- AIチャットのストリーミングレスポンス
- Server-Sent Events (SSE)
- Djangoセッション認証との連携

### 3. データベース (Supabase PostgreSQL)

| 項目 | 内容 |
|------|------|
| **バージョン** | PostgreSQL 17 |
| **拡張** | pgvector（ベクトル検索） |
| **接続** | SSL必須 |

**主要テーブル:**
- `users` - ユーザー情報
- `stores` - 店舗情報
- `daily_reports` - 日報
- `bbs_posts` - 掲示板投稿
- `document_vectors` - ベクトルデータ（RAG用）

### 4. ストレージ (Supabase Storage)

| 項目 | 内容 |
|------|------|
| **API** | S3互換 |
| **バケット** | `media` |
| **用途** | 日報画像の保存 |

---

## Djangoアプリケーション構成

```
C3/
├── c3_app/              # プロジェクト設定
│   ├── settings.py      # Django設定
│   ├── urls.py          # ルートURL設定
│   ├── wsgi.py          # WSGI設定
│   └── asgi.py          # ASGI設定
│
├── accounts/            # アカウント管理
│   ├── models.py        # User, UserManager
│   ├── views.py         # ログイン、プロフィール
│   └── forms.py         # 認証フォーム
│
├── stores/              # 店舗管理
│   ├── models.py        # Store, MonthlyGoal
│   └── views.py         # 目標更新
│
├── reports/             # 日報管理
│   ├── models.py        # DailyReport, ReportImage, StoreDailyPerformance
│   ├── views.py         # 日報CRUD
│   └── forms.py         # 日報フォーム
│
├── bbs/                 # 掲示板
│   ├── models.py        # BBSPost, BBSComment, BBSReaction
│   ├── views.py         # 投稿・コメント
│   └── forms.py         # 投稿フォーム
│
├── analytics/           # 分析ダッシュボード
│   ├── views.py         # ダッシュボード、カレンダー
│   └── services.py      # データ集計ロジック
│
├── ai_features/         # AI機能
│   ├── models.py        # AIChatHistory, DocumentVector, KnowledgeVector
│   ├── views.py         # チャットAPI
│   ├── agents/          # LangChainエージェント
│   └── tools/           # RAGツール
│
└── common/              # 共通機能
    ├── views.py         # ホーム、ヘルスチェック
    └── templates/       # ベーステンプレート
```

---

## 処理フロー

### 通常リクエスト（HTMX含む）

```
ブラウザ
   │
   ▼ HTTP Request
┌──────────────┐
│  Gunicorn    │
│  (WSGI)      │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  Django      │
│  Middleware  │
│  - Session   │
│  - CSRF      │
│  - Auth      │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  View        │
│  - Form検証  │
│  - DB操作    │
│  - Template  │
└──────┬───────┘
       │
       ▼
 HTTP Response
   │
   ▼
ブラウザ（HTML更新）
```

### AIチャットストリーミング

```
ブラウザ
   │
   ▼ POST /ai/api/chat/stream/
┌──────────────────────────────┐
│  c3-app (Django)             │
│  - 認証確認                  │
│  - ストリーミングURL生成     │
└──────────────┬───────────────┘
               │
               ▼
┌──────────────────────────────┐
│  c3-app-stream (FastAPI)     │
│  - Djangoセッション検証      │
│  - LangChainエージェント実行 │
│  - OpenAI API呼び出し        │
└──────────────┬───────────────┘
               │
     ▼ Server-Sent Events
ブラウザ（リアルタイム表示）
```

---

## セキュリティ設計

### 認証・認可

| 項目 | 実装 |
|------|------|
| **認証方式** | Djangoセッション認証 |
| **パスワード** | Django標準ハッシュ（PBKDF2） |
| **セッション** | データベースバックエンド |
| **CSRF保護** | Django CSRFミドルウェア |

### アクセス制御

```python
# ビューの保護例
@login_required
def report_list(request):
    # 自店舗のデータのみ取得
    reports = DailyReport.objects.filter(store=request.user.store)
    ...
```

### 環境変数による機密情報管理

| 変数 | 用途 |
|------|------|
| `SECRET_KEY` | Djangoセキュリティキー |
| `SUPABASE_DB_*` | データベース接続情報 |
| `OPENAI_API_KEY` | OpenAI APIキー |
| `SUPABASE_STORAGE_*` | ストレージ認証情報 |

---

## スケーラビリティ

### 現在の構成

- **ワーカー数**: 1（Render無料プラン考慮）
- **コネクションプール**: CONN_MAX_AGE=0（Supabase推奨）
- **キャッシュ**: なし（将来対応）

### スケールアップ時の考慮点

1. **水平スケーリング**: Gunicornワーカー数の増加
2. **キャッシュ導入**: Redis等によるセッション・クエリキャッシュ
3. **CDN**: 静的ファイルの外部配信
4. **読み取りレプリカ**: 分析クエリの負荷分散

---

## 監視・ログ

### ヘルスチェック

```
GET /health/
Response: {"status": "ok"}
```

### ログ出力

- Django標準ログ（console出力）
- Render ログダッシュボードで確認可能

---

## 関連ドキュメント

- [APIリファレンス](./api-reference.md)
- [データベーススキーマ](./database-schema.md)
- [デプロイガイド](./deployment.md)
