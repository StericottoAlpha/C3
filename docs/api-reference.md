# APIリファレンス

本ドキュメントでは、C3 ステリコットαの全エンドポイントを記載します。

---

## 認証について

ほとんどのエンドポイントはログインが必要です。未認証の場合、`/accounts/login/`にリダイレクトされます。

---

## エンドポイント一覧

### Common（共通）

#### ホームページ

| 項目 | 内容 |
|------|------|
| **URL** | `/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | ホーム画面を表示 |

**レスポンス**: HTMLページ

---

#### ヘルスチェック

| 項目 | 内容 |
|------|------|
| **URL** | `/health/` |
| **メソッド** | GET |
| **認証** | 不要 |
| **説明** | サーバーの稼働状況を確認 |

**レスポンス例**:
```json
{
  "status": "ok"
}
```

---

#### PWAマニフェスト

| 項目 | 内容 |
|------|------|
| **URL** | `/manifest.json` |
| **メソッド** | GET |
| **認証** | 不要 |
| **説明** | PWA用マニフェストファイル |

---

#### Service Worker

| 項目 | 内容 |
|------|------|
| **URL** | `/service-worker.js` |
| **メソッド** | GET |
| **認証** | 不要 |
| **説明** | PWA用Service Workerスクリプト |

---

### Accounts（アカウント管理）

#### ログイン

| 項目 | 内容 |
|------|------|
| **URL** | `/accounts/login/` |
| **メソッド** | GET, POST |
| **認証** | 不要 |
| **説明** | ログイン画面表示・認証処理 |

**POSTパラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `user_id` | string | はい | ユーザーID |
| `password` | string | はい | パスワード |

**成功時**: `/`にリダイレクト
**失敗時**: ログイン画面にエラーメッセージ表示

---

#### ログアウト

| 項目 | 内容 |
|------|------|
| **URL** | `/accounts/logout/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | ログアウト処理 |

**成功時**: `/accounts/login/`にリダイレクト

---

#### プロフィール

| 項目 | 内容 |
|------|------|
| **URL** | `/accounts/profile/` |
| **メソッド** | GET, POST |
| **認証** | 必要 |
| **説明** | プロフィール表示・更新 |

**POSTパラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `last_name` | string | いいえ | 姓 |
| `first_name` | string | いいえ | 名 |
| `email` | string | いいえ | メールアドレス |

---

#### サインアップ

| 項目 | 内容 |
|------|------|
| **URL** | `/accounts/signup/` |
| **メソッド** | GET, POST |
| **認証** | 不要 |
| **説明** | 新規ユーザー登録 |

**POSTパラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `user_id` | string | はい | ユーザーID（最大20文字） |
| `password` | string | はい | パスワード |
| `password_confirm` | string | はい | パスワード確認 |
| `store` | integer | はい | 店舗ID |

---

#### スタッフ一覧

| 項目 | 内容 |
|------|------|
| **URL** | `/accounts/staff-list/` |
| **メソッド** | GET |
| **認証** | 必要（管理者/店長） |
| **説明** | スタッフ一覧を表示 |

---

#### スタッフ編集

| 項目 | 内容 |
|------|------|
| **URL** | `/accounts/staff-edit/<user_id>/` |
| **メソッド** | GET, POST |
| **認証** | 必要（管理者/店長） |
| **説明** | スタッフ情報の編集 |

**URLパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|------|------|
| `user_id` | string | 編集対象のユーザーID |

---

### Stores（店舗管理）

#### 月次目標更新

| 項目 | 内容 |
|------|------|
| **URL** | `/stores/goal/update/` |
| **メソッド** | POST |
| **認証** | 必要 |
| **説明** | 当月の目標を更新（HTMX） |

**POSTパラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `goal_text` | string | はい | 目標内容 |
| `achievement_rate` | integer | いいえ | 達成率（0-100） |
| `achievement_text` | string | いいえ | 達成状況コメント |

**レスポンス**: 更新後の目標カードHTML（HTMX部分更新）

---

### Reports（日報管理）

#### 日報作成

| 項目 | 内容 |
|------|------|
| **URL** | `/report/register/` |
| **メソッド** | GET, POST |
| **認証** | 必要 |
| **説明** | 日報作成フォーム表示・登録 |

**POSTパラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `date` | date | はい | 日付（YYYY-MM-DD） |
| `genre` | string | はい | ジャンル（claim/praise/accident/report/other） |
| `location` | string | はい | 場所（kitchen/hall/cashier/toilet/other） |
| `title` | string | はい | 件名（最大200文字） |
| `content` | text | はい | 内容 |
| `post_to_bbs` | boolean | いいえ | 掲示板に投稿 |
| `images` | file[] | いいえ | 画像ファイル（複数可） |

**ジャンル選択肢**:
| 値 | 表示名 |
|------|------|
| `claim` | クレーム |
| `praise` | 賞賛 |
| `accident` | 事故 |
| `report` | 報告 |
| `other` | その他 |

**場所選択肢**:
| 値 | 表示名 |
|------|------|
| `kitchen` | キッチン |
| `hall` | ホール |
| `cashier` | レジ |
| `toilet` | トイレ |
| `other` | その他 |

---

#### 日報一覧

| 項目 | 内容 |
|------|------|
| **URL** | `/report/list/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | 自店舗の日報一覧を表示 |

**クエリパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|------|------|
| `page` | integer | ページ番号 |

---

#### 日報詳細

| 項目 | 内容 |
|------|------|
| **URL** | `/report/view/<report_id>/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | 日報の詳細を表示 |

**URLパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|------|------|
| `report_id` | integer | 日報ID |

---

### BBS（掲示板）

#### 投稿一覧

| 項目 | 内容 |
|------|------|
| **URL** | `/bbs/list/` |
| **メソッド** | GET, POST |
| **認証** | 必要 |
| **説明** | 掲示板投稿一覧を表示 |

**クエリパラメータ（GET）/ POSTパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|------|------|
| `genre` | string | ジャンルでフィルタ |
| `keyword` | string | キーワード検索 |
| `sort` | string | 並び順（new/popular） |

---

#### 投稿作成

| 項目 | 内容 |
|------|------|
| **URL** | `/bbs/register/` |
| **メソッド** | GET, POST |
| **認証** | 必要 |
| **説明** | 新規投稿作成 |

**POSTパラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `genre` | string | はい | ジャンル |
| `title` | string | はい | タイトル（最大200文字） |
| `content` | text | はい | 本文 |

---

#### 投稿詳細

| 項目 | 内容 |
|------|------|
| **URL** | `/bbs/detail/<bbs_id>/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | 投稿詳細とコメントを表示 |

**URLパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|------|------|
| `bbs_id` | integer | 投稿ID |

---

#### コメント追加

| 項目 | 内容 |
|------|------|
| **URL** | `/bbs/<bbs_id>/comment/` |
| **メソッド** | POST |
| **認証** | 必要 |
| **説明** | 投稿にコメントを追加 |

**URLパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|------|------|
| `bbs_id` | integer | 投稿ID |

**POSTパラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `content` | text | はい | コメント内容 |

---

#### リアクション切り替え

| 項目 | 内容 |
|------|------|
| **URL** | `/bbs/api/reaction/` |
| **メソッド** | POST |
| **認証** | 必要 |
| **説明** | 投稿/コメントへのリアクションを追加・削除 |

**POSTパラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|------|------|------|
| `post_id` | integer | 条件付き | 投稿ID（投稿へのリアクション時） |
| `comment_id` | integer | 条件付き | コメントID（コメントへのリアクション時） |
| `reaction_type` | string | はい | リアクション種別（naruhodo/iine） |

**リアクション種別**:
| 値 | 表示名 |
|------|------|
| `naruhodo` | なるほど |
| `iine` | いいね |

**レスポンス**: 更新後のリアクションボタンHTML（HTMX部分更新）

---

### Analytics（分析）

#### ダッシュボード

| 項目 | 内容 |
|------|------|
| **URL** | `/analysis/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | 分析ダッシュボードを表示 |

---

#### カレンダービュー

| 項目 | 内容 |
|------|------|
| **URL** | `/analysis/calendar/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | カレンダー形式で日報・実績を表示 |

---

#### カレンダー日別データAPI

| 項目 | 内容 |
|------|------|
| **URL** | `/analysis/calendar/day/<ymd>/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | 特定日のデータを取得 |

**URLパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|------|------|
| `ymd` | string | 日付（YYYY-MM-DD形式） |

**レスポンス例**:
```json
{
  "date": "2024-01-15",
  "reports": [...],
  "performance": {...}
}
```

---

#### カレンダー詳細

| 項目 | 内容 |
|------|------|
| **URL** | `/analysis/calendar/detail/<report_id>/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | 日報詳細をモーダル表示用に取得 |

**URLパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|------|------|
| `report_id` | integer | 日報ID |

---

#### グラフデータAPI

| 項目 | 内容 |
|------|------|
| **URL** | `/analysis/api/graph-data/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | グラフ表示用データを取得 |

**クエリパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|------|------|
| `period` | string | 期間（week/month/year） |
| `metric` | string | 指標（sales/customers/difference） |

**レスポンス例**:
```json
{
  "labels": ["1月", "2月", "3月"],
  "data": [100000, 120000, 115000]
}
```

---

#### 月次目標API

| 項目 | 内容 |
|------|------|
| **URL** | `/analysis/api/monthly-goal/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | 当月の月次目標を取得 |

**レスポンス例**:
```json
{
  "year": 2024,
  "month": 1,
  "goal_text": "売上前年比110%達成",
  "achievement_rate": 85,
  "achievement_text": "順調に推移中"
}
```

---

### AI Features（AI機能）

#### チャットページ

| 項目 | 内容 |
|------|------|
| **URL** | `/ai/chat/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | AIチャット画面を表示 |

---

#### チャットAPI（非ストリーミング）

| 項目 | 内容 |
|------|------|
| **URL** | `/ai/api/chat/` |
| **メソッド** | POST |
| **認証** | 必要 |
| **Content-Type** | application/json |
| **説明** | AIにメッセージを送信し、回答を取得 |

**リクエストボディ**:
```json
{
  "message": "今月のクレーム傾向を教えてください"
}
```

**レスポンス例**:
```json
{
  "response": "今月のクレーム傾向について分析しました..."
}
```

---

#### チャットAPI（ストリーミング）

| 項目 | 内容 |
|------|------|
| **URL** | `/ai/api/chat/stream/` |
| **メソッド** | POST |
| **認証** | 必要 |
| **Content-Type** | application/json |
| **説明** | AIにメッセージを送信し、ストリーミングで回答を取得 |

**リクエストボディ**:
```json
{
  "message": "過去1週間の売上傾向は？"
}
```

**レスポンス**: Server-Sent Events形式
```
data: {"type": "token", "content": "過去"}
data: {"type": "token", "content": "1週間"}
data: {"type": "token", "content": "の"}
...
data: {"type": "done"}
```

---

#### チャット履歴取得

| 項目 | 内容 |
|------|------|
| **URL** | `/ai/api/chat/history/` |
| **メソッド** | GET |
| **認証** | 必要 |
| **説明** | チャット履歴を取得 |

**レスポンス例**:
```json
{
  "history": [
    {
      "role": "user",
      "message": "こんにちは",
      "created_at": "2024-01-15T10:30:00Z"
    },
    {
      "role": "assistant",
      "message": "こんにちは！何かお手伝いできることはありますか？",
      "created_at": "2024-01-15T10:30:05Z"
    }
  ]
}
```

---

#### チャット履歴クリア

| 項目 | 内容 |
|------|------|
| **URL** | `/ai/api/chat/history/clear/` |
| **メソッド** | POST |
| **認証** | 必要 |
| **説明** | チャット履歴を削除 |

**レスポンス例**:
```json
{
  "success": true,
  "message": "履歴を削除しました"
}
```

---

### Admin（Django管理画面）

| 項目 | 内容 |
|------|------|
| **URL** | `/admin/` |
| **メソッド** | GET |
| **認証** | 必要（is_staff=True） |
| **説明** | Django管理画面 |

---

## エラーレスポンス

### 認証エラー（401/302）

未認証の場合、ログインページにリダイレクトされます。

### 権限エラー（403）

```json
{
  "error": "Permission denied"
}
```

### バリデーションエラー（400）

```json
{
  "errors": {
    "title": ["この項目は必須です。"],
    "content": ["この項目は必須です。"]
  }
}
```

### サーバーエラー（500）

```json
{
  "error": "Internal server error"
}
```

---

## 関連ドキュメント

- [システムアーキテクチャ](./architecture.md)
- [データベーススキーマ](./database-schema.md)
- [OpenAPI仕様](./openapi.yaml)
